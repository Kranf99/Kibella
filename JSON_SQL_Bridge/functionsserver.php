<?php
/*
JSON_SQL_Bridge
Copyright 2016 Frank Vanden berghen
All Right reserved.

JSON_SQL_Bridge is not a free software. The JSON_SQL_Bridge software is NOT licensed under the "Apache License". 
If you are interested in distributing, reselling, modifying, contibuting or in general creating 
any derivative work from JSON_SQL_Bridge, please contact Frank Vanden Berghen at frank@timi.eu.
*/
namespace kibella; require_once __DIR__."/constants.php"; require_once __DIR__."/constantscfg.php"; require_once __DIR__."/functionsaux.php"; require_once __DIR__."/functionsdb.php"; require_once __DIR__."/functionsmsg.php"; function l7z($O7x,$O68) { $laz=FALSE; if ($O68) { $lb0=$O7x["responseFileFinal"]; $Ob0=$O7x["responseFileTmp"]; $lg=checkdirexistsorcreate(CACHEDIR); if ($lg === FALSE) { showmessage( __FUNCTION__ ,TAG_ERROR,msgerrorexternaldircreate(CACHEDIR).lb1()); return FALSE; } if (file_exists($lb0) && !O51($lb0)) { $laz=TRUE; } else if (file_exists($Ob0)) { Oaz($lb0); if (file_exists($lb0)) { $laz=TRUE; } } } return $laz; } function O80($O7x,$O68) { if (file_exists($O7x["responseFileTmp"]) === TRUE) { $lax=Ob1($O7x); if ($lax !== FALSE && PHP_SAPI !== "cli") { if ($O7x["responseFileFinal"] !== O86(l1o)) { setrawcookie(l1o,$O7x["responseFileFinal"],strtotime("+365 days"),"/".APPDIRNAME."/"); setrawcookie(O1o,time(),strtotime("+365 days"),"/".APPDIRNAME."/"); setrawcookie(l1p,$O68*1,strtotime("+365 days"),"/".APPDIRNAME."/"); } } } } function l7y($l3k,$O7w) { if (is_string($O7w)) { $lb2=$O7w; } else { $lb2=serialize($O7w); } $lb0=CACHEDIR."/query_".$l3k.O2i.md5($l3k."\n".$lb2).".json"; $Ob2="_tmp"; $Ob0= "$lb0$Ob2"; $O7x=array("responseFileFinal" => $lb0,"responseFileTmp" => $Ob0); return $O7x; } function law($l52) { $lb3=substr($l52,strrpos($l52,O2i)+1); $Ob3=strrpos($lb3,"."); if ($Ob3>0) { $l6j=substr($lb3,0,$Ob3); } else { $l6j=$lb3; } return $l6j; } function O86($lb4) { if ( isset ($_COOKIE[$lb4])) { return $_COOKIE[$lb4]; } else { return ""; } } function l81($l52,$Ob4=5) { $lax=FALSE; if ($l52 !== NULL && $l52 !== FALSE && $l52 !== "") { $lb5=time(); $Ob5=strlen(ob_get_contents()); while ($lax === FALSE && (time()-$lb5)<=$Ob4) { @readfile($l52); if (PHP_SAPI === "cli" || strlen(ob_get_contents())>$Ob5 && @filesize($l52)>0) $lax=TRUE; } } return $lax; } function Ob1($O7x,$Ob4=5) { $lax=FALSE; $lb5=time(); while ($lax === FALSE && (time()-$lb5)<=$Ob4) { $lax=@rename($O7x["responseFileTmp"],$O7x["responseFileFinal"]); } return $lax; } function lb6($Ob6,$Oj="application/json") { header($_SERVER["SERVER_PROTOCOL"]." ".$Ob6); header("Access-Control-Allow-Origin: *"); header( "Content-Type: $Oj; charset=UTF-8"); } function lb7($l7u=TRUE) { $Ob7=O86(l2g); if ($Ob7 == "") { l6m(O26,$O48=FALSE); $l6l=dbcreatedbconnection(KIBELLADB); $lb8=dbdbhexecutesqlquery($l6l->getdbhandle(),"select ".O3." from ".O26." LIMIT 1"); $l6l->close(); if ($lb8 !== FALSE && count($lb8)>0) { $la=$lb8[0][O3]; } else { $la="INCOME(income)"; } } else { $la=$Ob7; } $Ob8="{\"".l1z."\":\"".l1n."\",\"".O1z."\":\"config\",\"".l20."\":\"".O1n."\",\"".O20."\":1,\"".O23."\":true,\"".O21."\":{"."\"buildNum\":1000,"."\"defaultIndex\":\"".$la."\""."}"."}"; if ($l7u) { $Ob8="{\"docs\":[".$Ob8."]}"; } O3n($Ob8); } function l8c($lb9) { $Ob9="{\"took\":2,\"timed_out\":false,\"".O22."\":{\"total\":1,\"successful\":1,\"failed\":0},"."\"hits\":{"."\"total\":".count($lb9).","."\"max_score\":1,"."\"hits\":".json_encode($lb9)."}"."}"; O3n($Ob9); } function O7b($Oj,$O1,$l7b,$lba,$Oba) { $Ob9="{\"".l1z."\":\"".l1n."\",\"".O1z."\":\"".$Oj."\",\"".l20."\":\"".$O1."\",\"".O20."\":".$l7b.",\"".O22."\":{\"total\":2,\"successful\":1,\"failed\":0},\"".$lba."\":".$Oba."}"; O3n($Ob9); } function lbb($lb4,$l3t,$Obb="",$lbc=NULL,$Obc=NULL) { if ($lbc === NULL) $lbc=strtotime("+365 days"); if ($Obc === NULL) $Obc="/".APPDIRNAME."/"; if ($Obb === "raw") { setrawcookie($lb4,$l3t,$lbc,$Obc); } else { setcookie($lb4,$l3t,$lbc,$Obc); } } function lbd($Obd,$lbe,$O5a) { $Obe=""; $lbf=""; if (strtolower($O5a) == "begin") { if ($lbe == "" || $lbe == NULL) { $Obf=$Obd; $lbe=""; } else $Obf=str_replace($lbe."/","",$Obd); $O4s=0; $lbg=""; if ($Obf[0] == "/") { $O4s=1; $lbg="/"; } if ($lbe == "") $Obg=""; else $Obg=$lbg.$lbe; $O5a=strpos($Obf,"/",$O4s); if ($O5a !== FALSE) { $Obe=$Obg.substr($Obf,$O5a); $lbf=substr($Obf,$O4s,$O5a-$O4s); } else { $lbh=Obh($Obd); $lbi=$lbh["URI"]; $lbf=substr($lbi,$O4s); } } else { $lbh=Obh($Obd); $lbi=$lbh["URI"]; $Obi=strlen($lbi); if ($lbi[$Obi-1] == "/") $lbi=substr($lbi,0,$Obi-1); $O5a=strrpos($lbi,"/"); if ($O5a !== FALSE) { if ($O5a<strlen($lbi)-1) $lbf=substr($lbi,$O5a+1); $Obe=substr($lbi,0,$O5a+1); } else $lbf=$lbi; } return array("URI" => $Obe,"object" => $lbf); } function Obh($Obd) { $O5a=strpos($Obd,"?"); if ($O5a === FALSE) { $lbj=$Obd; $l3q=NULL; } else { $lbj=substr($Obd,0,$O5a); if ($O5a == strlen($Obd)-1) { $l3q=NULL; } else { $Obj=substr($Obd,$O5a+1); $lbk=explode("&",$Obj); $l3q=Oy("=",$lbk); } } return array("URI" => $lbj,"params" => $l3q); } function O89($O3m) { $O3m=preg_replace("/\\s+/","-",$O3m); return $O3m; } function Obk($O3m) { $O3m=urldecode($O3m); return $O3m; } function Oaz($O4c,$lbl=l1m) { $lb5=time(); while (!file_exists($O4c) && (time()-$lb5)<=$lbl) { sleep(1); } }