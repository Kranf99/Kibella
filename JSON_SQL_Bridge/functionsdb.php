<?php
/*
JSON_SQL_Bridge
Copyright 2016 Frank Vanden berghen
All Right reserved.

JSON_SQL_Bridge is not a free software. The JSON_SQL_Bridge software is NOT licensed under the "Apache License".
If you are interested in distributing, reselling, modifying, contibuting or in general creating
any derivative work from JSON_SQL_Bridge, please contact Frank Vanden Berghen at frank@timi.eu.
*/
namespace kibella; require_once __DIR__."/classes.php"; require_once __DIR__."/constants.php"; require_once __DIR__."/globals.php"; require_once __DIR__."/functionsaux.php"; require_once __DIR__."/functionsauxkibella.php"; require_once __DIR__."/functionsdb.php"; require_once __DIR__."/functionsmsg.php"; require_once __DIR__."/functionsserver.php"; function Od($lb) { global $l6k; assert(array_search($lb,$l6k)>=0,"Invalid database provider '$lb'. Valid values are: '".implode("' , '",$l6k)."'"); } function O6k($l6l,$la,$lj) { $Of=O6l($l6l,$la); if ($Of === FALSE) { return FALSE; } foreach ($Of as $l6g) { if (l4d(strtolower($l6g["name"])) === strtolower($lj)) { return TRUE; } } return FALSE; } function l6m($la,$O48=FALSE) { if ($O48) { switch ($la) { case (O26): $O6m="registered tables"; break; case (l3): $O6m="saved objects"; break; case (l2c): $O6m="run queries"; break; default : break; } } $lg=checkdirexistsorcreate(TABLESDIR,$O48=$O48,$l49="The temporary directory with the application's information '".TABLESDIR."' was not found and is being recreated.\n"); if ($lg === FALSE) { showmessage( __FUNCTION__ ,TAG_ERROR,msgerrorinternaltablesdircouldnotcreate().msgnotecheckuserpermissions()); return FALSE; } $l6l=dbcreatedbconnection(KIBELLADB); if ($l6l->l1e() === RC_ERROR_NOTFOUND_DB) { if ($O48) showmessage("",l1q,"Internal database storing the application's information was not found and is being recreated.\n"); $lg=l6n($O48=FALSE); return $lg; } $lg=O6n($l6l,$la); if ($lg === RC_ERROR_NOTFOUND_TABLE) { if ($O48) showmessage("",l1q,"The internal table storing the $O6m was not found and is being recreated.\n"); $lg=l6o($l6l->getdbhandle(),$la,FALSE); } $l6l->close(); return $lg; } function O6n($l6l,$la) { $O5x=O6o($l6l,$la,l1t); $Of=dbdbhexecutesqlquery($l6l->getdbhandle(),$O5x); if ($Of === FALSE) { return FALSE; } if (count($Of) == 0) { return RC_ERROR_NOTFOUND_TABLE; } return TRUE; } function O6o($l6l,$la,$O53) { $l6p=O6p($l6l,$la); return l53($l6l->le ,$O53,$l6p); } function O6p($l6l,$la) { $l6p=$la; return $l6p; } function dbcreatedbconnection($l13,$O13=O18,$l6q=array("dir" => TABLESDIR),$O6q=array("new" => false)) { switch ($O13) { case (O18): return l6r($l13,$l47=$l6q["dir"]); break; default : global $O6r; showmessage( __FUNCTION__ ,TAG_ERROR,"Invalid DBMS type '$O13'. Valid values are: '".implode(" , ",$O6r)."'"); return FALSE; break; } } function l6r($Ok,$l47=TABLESDIR,$l6s=array("dbenginePDO" => O1r,"attributesPDO" => array( \pdo::ATTR_PERSISTENT => true,\pdo::ATTR_STRINGIFY_FETCHES => false,\pdo::ATTR_ERRMODE => \pdo::ERRMODE_SILENT))) { assert($l6s !== NULL && count($l6s)>=1 && array_key_exists("dbenginePDO",$l6s),"Input array \$optionsPDO contains the minimum required attributes"); if ($l47 !== "") $Ok= "$l47/$Ok"; $le=$l6s["dbenginePDO"]; $lb=O4q($le); if (array_key_exists("attributesPDO",$l6s) === FALSE) { $l6s["attributesPDO"]=NULL; } $l18=$lb; $l6l=new l11($Ok,O19,$l18,$Ok,O18,$le,$l6s["attributesPDO"]); return $l6l; } function O6s($O12,$la) { $O5x=l53(O1r,l1t,$la); $Of=dbdbhexecutesqlquery($O12,$O5x); if ($Of === FALSE) { return FALSE; } if (count($Of) == 0) { return RC_ERROR_NOTFOUND_TABLE; } return TRUE; } function l6t($l6l,$O6t=FALSE,$l6u="",$O6u=NULL) { if ($O6u == NULL) { $l6l->close(); } else { assert(count($O6u)>=2 && array_key_exists("dbhandle",$O6u) && array_key_exists("attachname",$O6u),"Input array \$dbAttachInfo contains the neccessary keys"); $l6v="DETACH DATABASE ".$O6u["attachname"]; dbdbhexecutesqlquery($l6l->getdbhandle(),$l6v,$O5="exec"); $O6u["dbhandle"]->close(); } if ($O6t === TRUE && $l6u != "" && $l6u != ":memory:") { unlink($l6u); } } function O1d(&$O12,$O6v=l1b) { switch ($O6v) { case (l1b): $O12=NULL; break; case (l1r): $O12->close(); break; default : $O12=NULL; break; } unset ($O12); } function l6o($O12,$la,$O48=FALSE) { assert($O12 !== NULL && $O12 != FALSE,"The database handle is not null nor false"); $lg=l6w($O12,$la); if ($lg === FALSE) { showmessage( __FUNCTION__ ,l1q,msgerrorinternaltabledrop($la)); } else { switch ($la) { case (O26): $O6w=O3." TEXT, ".l27." TEXT, ".O27." TEXT, ".l28." TEXT, ".O25." INT, ".O28." TEXT, ".l29." TEXT, ".O29." TEXT, ".l2a." NUMBER".",imageFields TEXT".",linkTemplate TEXT".",linkTemplateLabel TEXT".",imageTemplate TEXT".",imageTemplateLabel TEXT".",".l26." TEXT".", PRIMARY KEY(".O3.")"; $l6x="Registered tables"; break; case (l3): $O6w=O2a." TEXT, ".l4." TEXT, ".O3." TEXT, ".O25." INT, ".l2b." TEXT, ".O2b." TEXT, ".O2." INT, ".l8." INT, ".l26." TEXT"; $l6x="Saved objects (visualizations, dashboards, searches)"; break; case (l2c): $O6w=O2c." TEXT, ".O2d." TEXT, ".l2e." TEXT, ".O2e." INT, ".l2d." TEXT"; $l6x="Run queries"; break; default : $O6w=""; $l6x=""; break; } $lg=dbdbhexecutesqlquery($O12,"create table ".$la." ($O6w)" ,$O5="exec"); if ($lg === FALSE) { showmessage( __FUNCTION__ ,TAG_ERROR,msgerrorinternaltablecreate($la)); } else if ($O48) { echo msgnotesuccessfullydeleted($l6x); } } return $lg; } function O6x($O12,$O16) { if ($O16 != NULL) { foreach ($O16 as $l6y => $l3t) { $O12->setattribute($l6y,$l3t); } } } function l6w($O12,$la) { $lg=O6s($O12,$la); if ($lg === TRUE) { dbdbhexecutesqlquery($O12,"drop table $la" ,$O5="exec"); } return $lg; } function dbdbhexecutesqlquery($O12,$O5x,$O5="query",$l3q=NULL) { $l5=FALSE; if ($O5 == "exec") { try { if ($l3q != NULL) { $O6y=@$O12->prepare($O5x); foreach ($l3q as $l6z => $l3t) { $O6y->bindvalue($l6z,$l3t); } $l5=@$O6y->execute(); unset ($O6y); } else { $l5=@$O12->exec($O5x); } } catch ( \pdoexception $ll) { } } else { $O6y=O6z($O12,$O5x); if ($O6y) { if (get_class($O6y) == "PDOStatement") { $l5=$O6y->fetchall( \pdo::FETCH_ASSOC); } else if (get_class($O6y) == "SQLite3Result") { $l5=array(); while ($l70=$O6y->fetcharray(SQLITE3_ASSOC)) { $l5[]=$l70; } } } unset ($O6y); } return $l5; } function O70($O1,$l13,$la,$le,$Ob,$lc,$l6q=array("dir" => DATADIR)) { $l71=O71($l13,$la,$le,$l6q=$l6q); if ($l71 === FALSE) { return FALSE; } $l72=""; $O72=O49($Ob); $l73=O49($lc); $l5r=""; $O73=0; $l74=$l73; for ($O4a=0; $O4a<count($l71); $O4a ++) { $O74=$l71[$O4a]["name"]; $l75=$l71[$O4a]["type"]; $O75=l76($O74,$l75,$O72,$l73,$l74); $O76=$O75["FieldTypeIndex"]; if ($O76 !== "") { if ($O73>0) $l5r=","; $l72.=$l5r.dbgeneratefieldmetadatashort($O74,$O76); $O73 ++; } } if ($l73 != NULL) { l77($l72,$l73,$l71,"kibella\\dbGenerateFieldMetadataShort"); } $O77="{\"docs\":[{\"".l1z."\":\"".l1n."\",\"".O1z."\":\"index-pattern\",\"".l20."\":\"".$O1."\",\"".O20."\":1,\"".O23."\":true,\"".O21."\":{\"title\":\"".$O1."\","."\"fields\":".l4d($l72,TRUE)."}"."}]"."}"; return $O77; } function l78($O1,$l13,$la,$le,$Ob,$lc,$l6q=array("dir" => DATADIR)) { $l71=O71($l13,$la,$le,$l6q=$l6q); if ($l71 === FALSE) { return FALSE; } $O78="{\"".$O1."\":{"."\"mappings\":{"."\"row\":{"."\"_ttl\":{"."\"full_name\":\"_ttl\","."\"mapping\":{"."\"_ttl\":{"."\"enabled\":false,"."\"default\":-1"."}"."}"."}"; $O72=O49($Ob); $l73=O49($lc); $l5r=","; $l74=$l73; for ($O4a=0; $O4a<count($l71); $O4a ++) { $O74=$l71[$O4a]["name"]; $l75=$l71[$O4a]["type"]; $O75=l76($O74,$l75,$O72,$l73,$l74); $O76=$O75["FieldTypeMappings"]; if ($O76 !== "") { $O78.=$l5r.dbgeneratefieldmetadatalong($O74,$O76); } } if ($l73 != NULL) { l77($O78,$l73,$l71,"kibella\\dbGenerateFieldMetadataLong"); } $O78.="}"."}"."}"."}"; return $O78; } function O71($l13,$la,$le,$l6q=array("dir" => DATADIR)) { global $O54; $l6l=dbcreatedbconnection($l13,$O13=$O54[$le],$l6q=$l6q); if ($l6l->l1e()<0) { return FALSE; } $lg=O6n($l6l,$la); if ($lg === FALSE || $lg<0) { return FALSE; } $l71=O6l($l6l,$la); if ($l71 === FALSE) { return FALSE; } assert(count($l71)>0,"The number of fields in the table is > 0"); $l6l->close(); return $l71; } function l79($O79,$Oj,$O1) { l6m($O79,$O48=FALSE); switch ($Oj) { case (O1x): $l7a="where lower(".O3.") = '".strtolower($O1)."'"; break; default : $l7a="where ".l4." = '$Oj' and ".O3." = '".$O1."'"; break; } $l6b=dbcreatedbconnection(KIBELLADB); $Of=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".O25." from $O79 $l7a"); if ($Of !== FALSE && count($Of)>0) { $O7a="true"; $l7b=$Of[0][O25]*1; dbdbhexecutesqlquery($l6b->getdbhandle(),"delete from $O79 $l7a" ,$O5="exec"); } else { $O7a="false"; $l7b=1; } if ($Oj == O1x) { l6m(l3,$O48=FALSE); dbdbhexecutesqlquery($l6b->getdbhandle(),"delete from ".l3." where ".O2a." = '$O1'" ,$O5="exec"); } $l6b->close(); O7b($Oj,$O1,$l7b,O23,$O7a); } function l76($O74,$O76,&$O72,&$l73,$l74) { $l7c=FALSE; if ($l74 !== NULL && count($l74)>0) { $O7c="/_geohash[".O24."-".l25."]\$/i"; if (preg_match($O7c,$O74) === 1 && array_search(preg_replace($O7c,"",strtolower($O74)),$l74) !== FALSE) { $l7d=""; $O7d=""; $l7c=TRUE; } } if (!$l7c) { $l7e=array_search(strtolower($O74),$O72); if ($l7e !== FALSE) { $l7d="date"; $O7d="date"; unset ($O72[$l7e]); } else { $O7e=array_search(strtolower($O74),$l73); if ($O7e !== FALSE) { $l7d="geo_point"; $O7d="geo_point"; unset ($l73[$O7e]); } else { switch (( string) strtoupper($O76)) { case ("DOUBLE"): case ("FLOAT"): case ("REAL"): case ("NUMBER"): $l7d="number"; $O7d="double"; break; case ("BIGINT"): case ("INT"): $l7d="number"; $O7d="long"; break; case ("TEXT"): case ("VARCHAR"): case ("VARCHAR2"): $l7d="string"; $O7d="string"; break; default : showwarninginvalidfieldtype($O76); $l7d="string"; $O7d="string"; break; } } } } return array("FieldTypeIndex" => $l7d,"FieldTypeMappings" => $O7d); } function dbgeneratefieldmetadatalong($O74,$O76) { $O3m="\"".$O74."\":{"."\"full_name\":\"".$O74."\","."\"mapping\":{\"".$O74."\":{"."\"type\":\"".$O76."\","; if ($O76 === "date") { $O3m.="\"analyzer\":\"_date/16\","."\"search_analyzer\":\"_date/max\","."\"format\":\"yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_second\","."\"numeric_resolution\":\"seconds\","; } $O3m.="\"index\":\"not_analyzed\""."}"."}"."}"; return $O3m; } function dbgeneratefieldmetadatashort($O74,$O76) { return "{"."\"name\":\"".$O74."\","."\"type\":\"".$O76."\","."\"count\":0,"."\"scripted\":false,"."\"indexed\":true,"."\"analyzed\":false,"."\"doc_values\":true"."}"; } function l77(&$O3m,&$l73,$l7f,$O7f) { assert($l73 != NULL,"the input geofields array is not null"); foreach ($l73 as $l7g) { $l7g=strtolower($l7g); $O7g=FALSE; $l7h=FALSE; $O7h=FALSE; foreach ($l7f as $l6g) { $O74=$l6g["name"]; $l7i=strtolower($O74); if ($l7i === $l7g."_lat") $O7g=TRUE; if ($l7i === $l7g."_lon") $l7h=TRUE; $O7i=$l7g."_geohash"; $l7j=substr($l7i,0,strlen($O7i)); $O7j=substr($l7i,strlen($O7i)); if ($l7j === $O7i && O24<=$O7j && $O7j<=l25) $O7h=TRUE; if ($O7g && $l7h && $O7h) break; } if ($O7g && $l7h && $O7h) { if ($O3m == "") $l5r=""; else $l5r=","; $l7k=substr($O74,0,strlen($l7g)); $O3m.=$l5r.call_user_func($O7f,$l7k,"geo_point"); } unset ($l73[$l7g]); } return $O3m; } function O3k($la,$Oa) { $O7k=strstr($Oa,".",TRUE); if (empty($O7k)) { $O7k=$Oa; } return strtoupper($O7k)."(".strtolower($la).")"; } function l7l() { if (PHP_SAPI !== "cli") { $O7l=str_replace([":","."],"_",$_SERVER["REMOTE_ADDR"]); $l7m=$O7l."_"; } else { $l7m=""; } return "_$l7m".floor(microtime(1))."_".rand(0,023420); } function Oi($O1) { $O75=FALSE; $O77=O7m($O1); $l7n=json_decode($O77,TRUE); if ($l7n != NULL && array_key_exists("docs",$l7n) && count($l7n["docs"])>0) { $O7n=$l7n["docs"][0][O21]["fields"]; $l7o=json_decode($O7n,TRUE); $O75=array(); foreach ($l7o as $O7o) { $O75["\"".$O7o["name"]."\""]=$O7o["type"]; } } return $O75; } function O6d($l3k) { l6m(l3,$O48=FALSE); $l6b=dbcreatedbconnection(KIBELLADB); $l6d=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".O2a.", ".O3.", ".l2b." from ".l3." where ".l4." = '".O4."' and ".O2a." = '".$l3k."'"); $l6b->close(); if ($l6d == FALSE or count($l6d) == 0) { return FALSE; } return $l6d; } function O6i($l3k,$O6g=0) { l6m(l2c,$O48=FALSE); $l6b=dbcreatedbconnection(KIBELLADB); $l6i=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".O2c.", ".O2d.", ".l2e.", ".O2e." from ".l2c." where ".O2d." = '".$l3k."' and ".O2e." >= $O6g"." order by ".O2e." desc"); $l6b->close(); if ($l6i == FALSE or count($l6i) == 0) { return FALSE; } return $l6i; } function l6f($l3k) { l6m(l2c,$O48=FALSE); $l6b=dbcreatedbconnection(KIBELLADB); $l7p=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".O2e.", count(*) as n "." from ".l2c." where ".O2d." = '".$l3k."'"." group by ".O2e." order by ".O2e." desc"); $l6b->close(); if ($l7p === FALSE or count($l7p) == 0) { return FALSE; } return $l7p; } function O7p($l13,$le) { if ($le === O1r) { return basename(realpath(DATADIR."/$l13")); } else { return $l13; } } function l69($l3k) { l6m(O26,$O48=FALSE); $l6b=dbcreatedbconnection(KIBELLADB); $l7q=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".l27.", ".O27.", ".l28.", ".l2a." from ".O26." where ".O3." = '$l3k'"); $l6b->close(); if ($l7q == FALSE or count($l7q) == 0) { return FALSE; } $la=$l7q[0][l27]; $Oa=$l7q[0][O27]; $le=Oe($l7q[0][l28]); $O7q=strtolower(CACHEMODE) !== "none" && ($l7q[0][l2a] == 1); $l7r=array("table" => $la,"db" => $Oa,"dbengine" => $le,"cache" => $O7q); return $l7r; } function O7m($l3k) { l6m(O26,$O48=FALSE); $l6b=dbcreatedbconnection(KIBELLADB); $Of=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".l27.", ".O27.", ".l28.", ".O28.", ".l29.", ".O29." from ".O26." where lower(".O3.") = '".strtolower($l3k)."'"); $l6b->close(); if ($Of !== FALSE && count($Of)>0) { $la=$Of[0][l27]; $Oa=$Of[0][O27]; $le=Oe($Of[0][l28]); $Ob=$Of[0][O28]; $lc=$Of[0][l29]; $Oc=$Of[0][O29]; $O77=O70($l3k,$Oa,$la,$le,$Ob,$lc); } else { $O77=FALSE; } return $O77; } function O7r($O1) { l6m(O26,$O48=FALSE); $l6b=dbcreatedbconnection(KIBELLADB); $Of=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".l27.", ".O27.", ".l28.", ".O28.", ".l29.", ".O29." from ".O26." where lower(".O3.") = '".strtolower($O1)."'"); $l6b->close(); if ($Of !== FALSE && count($Of)>0) { $la=$Of[0][l27]; $Oa=$Of[0][O27]; $le=Oe($Of[0][l28]); $Ob=$Of[0][O28]; $lc=$Of[0][l29]; $Oc=$Of[0][O29]; $O78=l78($O1,$Oa,$la,$le,$Ob,$lc); } else { $O78=FALSE; } return $O78; } function O6l($l6l,$la) { $O5x=O6o($l6l,$la,O1t); $Of=dbdbhexecutesqlquery($l6l->getdbhandle(),$O5x); return $Of; } function l7s($O7s) { $l7t=json_decode($O7s["kibanaSavedObjectMeta"]["searchSourceJSON"],TRUE); return $l7t["index"]; } function O7t($Oj,$O1,$l7u=TRUE) { l6m(l3,$O48=FALSE); $l6b=dbcreatedbconnection(KIBELLADB); $O7u=dbdbhexecutesqlquery($l6b->getdbhandle(),"select * from ".l3." where ".l4." = '".$Oj."' and ".O3." = '".$O1."'"); $l6b->close(); if ($O7u === FALSE) { echo TAG_ERROR_INTERNAL." when reading from Objects table '".l3."'. ".O1q.".\n"; } else { if (count($O7u) == 0) { $l7v="{\"".l1z."\":\"".l1n."\",\"".O1z."\":\"".$Oj."\",\"".l20."\":\"".$O1."\",\"".O23."\":false"."}"; if ($l7u) { $l7v="{\"docs\":[".$l7v."]}"; } } else { $l7v="{\"".l1z."\":\"".l1n."\",\"".O1z."\":\"".$O7u[0][l4]."\",\"".l20."\":\"".$O7u[0][O3]."\",\"".O20."\":".$O7u[0][O25]*1 .",\"".O23."\":true,\"".O21."\":".$O7u[0][l2b]; $O7v=$O7u[0][l22]; if ($O7v) $l7v.=",\"".l22."\":".$O7v; $l7v.="}"; if ($l7u) { $l7v="{\"docs\":[".$l7v."]}"; } } O3n($l7v); } } function l7w($l3k,$O7w,$l7x) { $l7r=l69($l3k); $la=$l7r["table"]; $Oa=$l7r["db"]; $le=$l7r["dbengine"]; $O68=$l7r["cache"]; $O7x=l7y($l3k,$O7w); $O7y=l7z($O7x,$O68); if ($O7y === FALSE) { $O7z["xaggs"]=array(); $O7z["yaggs"]=array(); $O7z["filter"]="where ".l2f." = $l7x"; $O7z["onerec"]=$O7z["filter"]; $O7z["discover"]=array("tab" => TRUE,"limit" => 1); global $O54; l80($la,$Oa,$O54[$le],$O7z,$O7x["responseFileTmp"]); O80($O7x,$O68); } l81($O7x["responseFileFinal"]); } function O81($O1) { $O77=O7m($O1); if ($O77 !== FALSE) { $l5m=$O77; } else { $la=l2i; $Oa=l2h; $O1=O3k($la,$Oa); $l5m="{\"docs\":[{\"".l1z."\":\"".l1n."\",\"".O1z."\":\"index-pattern\",\"".l20."\":\"".$O1."\",\"".O20."\":1,\"".O23."\":true,\"".O21."\":{\"title\":\"".$O1."\","."\"fields\":\"[{}]\""."}"."}]"."}"; } O3n($l5m); } function l82($O1) { $O78=O7r($O1); if ($O78 !== FALSE) { $l5m=$O78; } else { $la=l2i; $Oa=l2h; $O1=O3k($la,$Oa); $O74="_dummy"; $O76="string"; $l5m="{\"".$O1."\":{"."\"mappings\":{"."\"row\":{"."\"_ttl\":{"."\"full_name\":\"_ttl\","."\"mapping\":{"."\"_ttl\":{"."\"enabled\":false,"."\"default\":-1"."}"."}"."},\"".$O74."\":{"."\"full_name\":\"".$O74."\","."\"mapping\":{\"".$O74."\":{"."\"type\":\"".$O76."\","."\"index\":\"not_analyzed\""."}"."}"."}"."}"."}"."}"."}"; } O3n($l5m); } function O6z($O12,$O5x) { $O6y=FALSE; if ($O12 !== FALSE) { $O6y=@$O12->query($O5x); } return $O6y; } function O82($O6y) { $l5=FALSE; if ($O6y) { if (get_class($O6y) == "PDOStatement") { $l5=$O6y->fetch( \pdo::FETCH_ASSOC); } else if (get_class($O6y) == "SQLite3Result") { $l5=$O6y->fetcharray(SQLITE3_ASSOC); } } return $l5; } function l83($l3k,$O5x,$l6j) { $lg=l6m(l2c,$O48=FALSE); $l6b=dbcreatedbconnection(KIBELLADB); $Of=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".O2c.", ".O2e." from ".l2c." where ".O2c." = '".$l6j."'"." and ".O2d." = '$l3k'"); $O83=strftime("%Y/%m/%d %H:%M:%S",time()); if (count($Of) == 0) { $l84="true"; $O6j=1; $l5=dbdbhexecutesqlquery($l6b->getdbhandle(),"insert into ".l2c." values(\t'$l6j',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$l3k',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O5x',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$O6j,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O83'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)" ,$O5="exec"); } else { $O6j=$Of[0][O2e]+1; $l5=dbdbhexecutesqlquery($l6b->getdbhandle(),"update ".l2c." set ".O2c." = '$l6j', ".O2d." = '$l3k', ".l2e." = '$O5x', ".O2e." = $O6j, ".l2d." = '$O83'"." where ".O2c." = '$l6j'" ,$O5="exec"); } $l6b->close(); } function dbregistertable($lf) { $l7=new user(); if (PHP_SAPI !== "cli" && !$l7->isloggedin()) return FALSE; $la=$lf["table"]; $Oa=$lf["db"]; $lb=$lf["dbprovider"]; $Ob=$lf["datefields"]; $lc=$lf["geofields"]; $Oc=$lf["linkfields"]; $ld=$lf["enablecache"]; if ($Oa == "") { showmessage("","note",msgerrorexternalenteravalue("Database")); } if ($la == "") { showmessage("","note",msgerrorexternalenteravalue("Table")); } if ($Oa == "" || $la == "") { return FALSE; } $le=Oe($lb); global $O54; $l6l=dbcreatedbconnection($Oa,$O13=$O54[$le],$l6q=array("dir" => DATADIR)); if ($l6l->l1e()<0) { $O1=""; $lg=$l6l->l1e(); } else { $lg=O6n($l6l,$la); if ($lg === FALSE || $lg<0) { $O1=""; } else { $lg=FALSE; $Oa=O7p($Oa,$le); $O1=O3k($la,$Oa); $lg=l6m(O26,$O48=TRUE); if ($lg === FALSE) { return array("id" => $O1,"rc" => FALSE); } $lg=FALSE; $O83=strftime("%Y/%m/%d %H:%M:%S",time()); $l6b=dbcreatedbconnection(KIBELLADB); $Of=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".O25." from ".O26." where lower(".O3.") = '".strtolower($O1)."'"); if ($Of === FALSE) { $lg=FALSE; } else if (count($Of) == 0) { $l7b=1; $l5=dbdbhexecutesqlquery($l6b->getdbhandle(),"insert into ".O26." (".O3.",".l27.",".O27.",".l28.",".O25.",".O28.",".l29.",".O29.",".l2a.",".l26.")"." values(\t'$O1',\n\t\t\t\t\t\t\t\t\t\t'$la',\n\t\t\t\t\t\t\t\t\t\t'$Oa',\n\t\t\t\t\t\t\t\t\t\t'$lb',\n\t\t\t\t\t\t\t\t\t\t$l7b,\n\t\t\t\t\t\t\t\t\t\t'$Ob',\n\t\t\t\t\t\t\t\t\t\t'$lc',\n\t\t\t\t\t\t\t\t\t\t'$Oc',\n\t\t\t\t\t\t\t\t\t\t'$ld',\n\t\t\t\t\t\t\t\t\t\t'$O83'\n\t\t\t\t\t\t\t\t\t)" ,$O5="exec"); if ($l5 !== FALSE) $lg=RC_NOTE_TABLE_ADDED; } else { $l7b=$Of[0][O25]+1; $l5=dbdbhexecutesqlquery($l6b->getdbhandle(),"update ".O26." set ".l27." = '$la', ".O27." = '$Oa', ".l28." = '$lb', ".O25." =  $l7b, ".O28." = '$Ob', ".l29." = '$lc', ".O29." = '$Oc', ".l2a." = $ld, ".l26." = '$O83'"." where lower(".O3.") = '".strtolower($O1)."'",$O5="exec"); if ($l5 !== FALSE) $lg=RC_NOTE_TABLE_UPDATED; } $l6b->close(); } } return array("id" => $O1,"rc" => $lg); } function l6n($O48=FALSE) { $lg=TRUE; $l6b=dbcreatedbconnection(KIBELLADB); if ($l6b === FALSE) { return FALSE; } $O84=array(O26,l3,l2c); $lg=TRUE; foreach ($O84 as $la) { $lg=$lg && l6o($l6b->getdbhandle(),$la,$O48=$O48); } $l6b->close(); return $lg; } function l85($Oj,$O85) { $l7=new user(); if (PHP_SAPI !== "cli" && !$l7->isloggedin()) return FALSE; $l86=json_decode($O85,TRUE); switch ($Oj) { case (l1y): case (O1y): $l3k=l7s($l86); $O5x=O86(O2g); break; case (O4): $l3k=O86(l2g); $O5x=""; break; default : $l3k=""; $O5x=""; break; } $lg=l6m(l3,$O48=FALSE); if (ADDTABLEPREFIX == 1) { $l87= "$l3k: "; $O87=strpos($O85,$l87); if ($O87 === strlen("{\"title\":\"")) { $O85=substr_replace($O85,"",$O87,strlen($l87)); } } else { $l87=""; } $l88="\"title\":\"([^\"]+)\""; $O85=preg_replace( "/$l88/" ,"\"title\":\"".$l87."\$1\"",$O85); preg_match( "/$l88/" ,$O85,$l4v); if (count($l4v)>1) { $O88=$l4v[1]; $l89=O89($O88); } else { $l89=""; } $l6b=dbcreatedbconnection(KIBELLADB); $Of=dbdbhexecutesqlquery($l6b->getdbhandle(),"select ".O3.", ".O25." from ".l3." where ".l4." = '$Oj' and ".O3." = '".$l89."'"); $O83=strftime("%Y/%m/%d %H:%M:%S",time()); if (count($Of) == 0) { $l84="true"; $l7b=1; $l5=dbdbhexecutesqlquery($l6b->getdbhandle(),"insert into ".l3." values(\t'$l3k',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$Oj',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$l89',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$l7b,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O85',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O5x', ".O2f.", 1,"."'$O83'".")",$O5="exec"); } else { $l84="false"; $l7b=$Of[0][O25]+1; $l5=dbdbhexecutesqlquery($l6b->getdbhandle(),"update ".l3." set ".O2a." = '$l3k', ".l4." = '$Oj', ".O3." = '$l89', ".O25." = $l7b, ".l2b." = '$O85', ".O2b." = '$O5x', ".l26." = '$O83'"." where ".O3." = '$l89'" ,$O5="exec"); } $l6b->close(); O7b($Oj,$l89,$l7b,l23,$l84); } function l8a($O79,$Oj,$O62) { l6m($O79,$O48=FALSE); switch ($Oj) { case (O4): case (l1y): case (O1y): $O8a=l4; $l8b=O3; $O8b=l2b; $l7a= "where $O8a = '$Oj'"; if (LISTONLYTABLEOBJECTS === 1) { $la=O86(l2g); if ($la !== "") { $l7a.=" and ".O2a." = '$la'"; } } if ($O62 != "*") { $O62=str_replace(" ","-",$O62); $l7a.= " and lower($l8b) GLOB lower('*".$O62."')"; } $l6b=dbcreatedbconnection(KIBELLADB); $l5v=dbdbhexecutesqlquery($l6b->getdbhandle(),"select $O8a, $l8b, $O8b\n\t\t\t\t\t\t\t\t\t\t\t\tfrom $O79\n\t\t\t\t\t\t\t\t\t\t\t\t$l7a\n\t\t\t\t\t\t\t\t\t\t\t\torder by $l8b"); $l6b->close(); break; case (O1x): $l8b=O3; $O8b=O25; $l6b=dbcreatedbconnection(KIBELLADB); $l5v=dbdbhexecutesqlquery($l6b->getdbhandle(),"select $l8b, $O8b\n\t\t\t\t\t\t\t\t\t\t\t\tfrom $O79\n\t\t\t\t\t\t\t\t\t\t\t\torder by $l8b"); $l6b->close(); break; default : showmessage( __FUNCTION__ ,TAG_ERROR_INTERNAL,"Invalid object type ($Oj). ".O1q.".\n"); break; } if ($l5v === FALSE) { showmessage( __FUNCTION__ ,TAG_ERROR_INTERNAL,"when reading from table '$O79'. ".O1q.".\n"); } else { if ($Oj == O4 || $Oj == l1y || $Oj == O1y) { for ($O4a=0; $O4a<count($l5v); $O4a ++) { $l5v[$O4a][$O8b]=json_decode($l5v[$O4a][$O8b],TRUE); } } else if ($Oj == O1x) { for ($O4a=0; $O4a<count($l5v); $O4a ++) { $l5v[$O4a][l4]=O1x; $l5v[$O4a][$O8b]=$l5v[$O4a][$O8b]*1; } } l8c($l5v); } }