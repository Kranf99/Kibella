<?php
/*
JSON_SQL_Bridge 1.0
Copyright 2016 Frank Vanden berghen
All Right reserved.

JSON_SQL_Bridge is not a free software. The JSON_SQL_Bridge software is NOT licensed under the "Apache License".
If you are interested in distributing, reselling, modifying, contibuting or in general creating
any derivative work from JSON_SQL_Bridge, please contact Frank Vanden Berghen at frank@timi.eu.
*/
namespace kibella; use O33\l34\l67\O67\l68; function O4e($lp) { global $O68; assert(array_search($lp,$O68)>=0,"Invalid database engine '$lp'. Valid values are: '".implode("' , '",$O68)."'"); } function l69($O69,$l31,$O48) { $l6a=O6a($O69,$l31); if ($l6a === FALSE) { return FALSE; } foreach ($l6a as $l63) { if (O3x(strtolower($l63["name"])) === strtolower($O48)) { return TRUE; } } return FALSE; } function l6b($l31,$l3s=FALSE) { if ($l3s) { switch ($l31) { case (l1n): $O6b="registered tables"; break; case (l3): $O6b="saved objects"; break; case (O1s): $O6b="run queries"; break; default : break; } } $l3t=checkdirexistsorcreate(TABLESDIR,$l3s=$l3s,$O3s="The temporary directory with the application's information '".TABLESDIR."' was not found and is being recreated.\n"); if ($l3t === FALSE) { showmessage( __FUNCTION__ ,TAG_ERROR,l6c().O6c()); return FALSE; } $O69=dbcreatedbconnection(KIBELLADB); if ($O69->lu() === RC_ERROR_NOTFOUND_DB) { if ($l3s) showmessage("",O16,"Internal database storing the application's information was not found and is being recreated.\n"); $l3t=l6d($l3s=FALSE); return $l3t; } $l3t=O6d($O69,$l31); if ($l3t === RC_ERROR_NOTFOUND_TABLE) { if ($l3s) showmessage("",O16,"The internal table storing the $O6b was not found and is being recreated.\n"); $l3t=l6e($O69->getdbhandle(),$l31,FALSE); } $O69->close(); return $l3t; } function O6d($O69,$l31) { $O5k=O6e($O69,$l31,l1a); $l6a=dbdbhexecutesqlquery($O69->getdbhandle(),$O5k); if ($l6a === FALSE) { return FALSE; } if (count($l6a) == 0) { return RC_ERROR_NOTFOUND_TABLE; } return TRUE; } function O6e($O69,$l31,$l4r) { $l6f=O6f($O69,$l31); return O4q($O69->lp ,$l4r,$l6f); } function O6f($O69,$l31) { $l6f=$l31; return $l6f; } function dbcreatedbconnection($lo,$Oo=l18,$l6g=array("dir" => TABLESDIR),$O6g=array("new" => false)) { switch ($Oo) { case (l18): return l6h($lo,$O3q=$l6g["dir"]); break; default : global $O6h; showmessage( __FUNCTION__ ,TAG_ERROR,"Invalid DBMS type '$Oo'. Valid values are: '".implode(" , ",$O6h)."'"); return FALSE; break; } } function l6h($l9,$O3q=TABLESDIR,$l6i=array("dbenginePDO" => l19,"attributesPDO" => array( \pdo::ATTR_PERSISTENT => true,\pdo::ATTR_STRINGIFY_FETCHES => false,\pdo::ATTR_ERRMODE => \pdo::ERRMODE_SILENT))) { assert($l6i !== NULL && count($l6i)>=1 && array_key_exists("dbenginePDO",$l6i),"Input array \$optionsPDO contains the minimum required attributes"); if ($O3q !== "") $l9= "$O3q/$l9"; $O4c=$l6i["dbenginePDO"]; $O4d=l4c($O4c); if (array_key_exists("attributesPDO",$l6i) === FALSE) { $l6i["attributesPDO"]=NULL; } $O69=new Ou($l9,"$O4d:$l9" ,l18,$O4c,$l6i["attributesPDO"]); return $O69; } function O6i($Op,$l31) { $O5k=O4q(l19,l1a,$l31); $l6a=dbdbhexecutesqlquery($Op,$O5k); if ($l6a === FALSE) { return FALSE; } if (count($l6a) == 0) { return RC_ERROR_NOTFOUND_TABLE; } return TRUE; } function l6j($O69,$O6j=FALSE,$l6k="",$O6k=NULL) { if ($O6k == NULL) { $O69->close(); } else { assert(count($O6k)>=2 && array_key_exists("dbhandle",$O6k) && array_key_exists("attachname",$O6k),"Input array \$dbAttachInfo contains the neccessary keys"); $l6l="DETACH DATABASE ".$O6k["attachname"]; dbdbhexecutesqlquery($O69->getdbhandle(),$l6l,$O5="exec"); $O6k["dbhandle"]->close(); } if ($O6j === TRUE && $l6k != "" && $l6k != ":memory:") { unlink($l6k); } } function Ot(&$Op,$O6l=lt) { switch ($O6l) { case (lt): $Op=NULL; break; case (O17): $Op->close(); break; default : $Op=NULL; break; } unset ($Op); } function l6e($Op,$l31,$l3s=FALSE) { assert($Op !== NULL && $Op != FALSE,"The database handle is not null nor false"); $l3t=l6m($Op,$l31); if ($l3t === FALSE) { showmessage( __FUNCTION__ ,O16,O6m($l31)); } else { switch ($l31) { case (l1n): $l6n=O3." TEXT, ".O1n." TEXT, ".l1o." TEXT, ".O1o." TEXT, ".l1m." INT, ".l1p." TEXT, ".O1p." TEXT, ".l1q." TEXT, ".O1q." NUMBER".",imageFields TEXT".",linkTemplate TEXT".",linkTemplateLabel TEXT".",imageTemplate TEXT".",imageTemplateLabel TEXT".",".O1m." TEXT".", PRIMARY KEY(".O3.")"; $O6n="Registered tables"; break; case (l3): $l6n=l1r." TEXT, ".l4." TEXT, ".O3." TEXT, ".l1m." INT, ".O1r." TEXT, ".l1s." TEXT, ".O2." INT, ".O1m." TEXT"; $O6n="Saved objects (visualizations, dashboards, searches)"; break; case (O1s): $l6n=l1t." TEXT, ".l1u." TEXT, ".O1u." TEXT, ".l1v." INT, ".O1t." TEXT"; $O6n="Run queries"; break; default : $l6n=""; $O6n=""; break; } $l3t=dbdbhexecutesqlquery($Op,"create table ".$l31." ($l6n)" ,$O5="exec"); if ($l3t === FALSE) { showmessage( __FUNCTION__ ,TAG_ERROR,l6o($l31)); } else if ($l3s) { echo O6o($O6n); } } return $l3t; } function l6p($Op,$Os) { if ($Os != NULL) { foreach ($Os as $O6p => $O3c) { $Op->setattribute($O6p,$O3c); } } } function l6m($Op,$l31) { $l3t=O6i($Op,$l31); if ($l3t === TRUE) { dbdbhexecutesqlquery($Op,"drop table $l31" ,$O5="exec"); } return $l3t; } function dbdbhexecutesqlquery($Op,$O5k,$O5="query",$O39=NULL) { $l5=FALSE; if ($O5 == "exec") { try { if ($O39 != NULL) { $l6q=@$Op->prepare($O5k); foreach ($O39 as $O6q => $O3c) { $l6q->bindvalue($O6q,$O3c); } $l5=@$l6q->execute(); unset ($l6q); } else { $l5=@$Op->exec($O5k); } } catch ( \pdoexception $O9) { } } else { $l6q=l6r($Op,$O5k); if ($l6q) { if (get_class($l6q) == "PDOStatement") { $l5=$l6q->fetchall( \pdo::FETCH_ASSOC); } else if (get_class($l6q) == "SQLite3Result") { $l5=array(); while ($O6r=$l6q->fetcharray(SQLITE3_ASSOC)) { $l5[]=$O6r; } } } unset ($l6q); } return $l5; } function l6s($O1,$lo,$l31,$lp,$O6s,$l6t,$l6g=array("dir" => DATADIR)) { $O6t=l6u($lo,$l31,$lp,$l6g=$l6g); if ($O6t === FALSE) { return FALSE; } $O6u=""; $l6v=O3t($O6s); $O6v=O3t($l6t); $l5e=""; $l6w=0; $O6w=$O6v; for ($l3v=0; $l3v<count($O6t); $l3v ++) { $l6x=$O6t[$l3v]["name"]; $O6x=$O6t[$l3v]["type"]; $l6y=O6y($l6x,$O6x,$l6v,$O6v,$O6w); $l6z=$l6y["FieldTypeIndex"]; if ($l6z !== "") { if ($l6w>0) $l5e=","; $O6u.=$l5e.dbgeneratefieldmetadatashort($l6x,$l6z); $l6w ++; } } if ($O6v != NULL) { O6z($O6u,$O6v,$O6t,"kibella\\dbGenerateFieldMetadataShort"); } $l70="{\"docs\":[{\"".O1f."\":\"".O13."\",\"".l1g."\":\"index-pattern\",\"".O1g."\":\"".$O1."\",\"".l1h."\":1,\"".l1k."\":true,\"".l1i."\":{\"title\":\"".$O1."\","."\"fields\":".O3x($O6u,TRUE)."}"."}]"."}"; return $l70; } function O70($O1,$lo,$l31,$lp,$O6s,$l6t,$l6g=array("dir" => DATADIR)) { $O6t=l6u($lo,$l31,$lp,$l6g=$l6g); if ($O6t === FALSE) { return FALSE; } $l71="{\"".$O1."\":{"."\"mappings\":{"."\"row\":{"."\"_ttl\":{"."\"full_name\":\"_ttl\","."\"mapping\":{"."\"_ttl\":{"."\"enabled\":false,"."\"default\":-1"."}"."}"."}"; $l6v=O3t($O6s); $O6v=O3t($l6t); $l5e=","; $O6w=$O6v; for ($l3v=0; $l3v<count($O6t); $l3v ++) { $l6x=$O6t[$l3v]["name"]; $O6x=$O6t[$l3v]["type"]; $l6y=O6y($l6x,$O6x,$l6v,$O6v,$O6w); $l6z=$l6y["FieldTypeMappings"]; if ($l6z !== "") { $l71.=$l5e.dbgeneratefieldmetadatalong($l6x,$l6z); } } if ($O6v != NULL) { O6z($l71,$O6v,$O6t,"kibella\\dbGenerateFieldMetadataLong"); } $l71.="}"."}"."}"."}"; return $l71; } function l6u($lo,$l31,$lp,$l6g=array("dir" => DATADIR)) { global $O4s; $O69=dbcreatedbconnection($lo,$Oo=$O4s[$lp],$l6g=$l6g); if ($O69->lu()<0) { return FALSE; } $l3t=O6d($O69,$l31); if ($l3t === FALSE || $l3t<0) { return FALSE; } $O6t=O6a($O69,$l31); if ($O6t === FALSE) { return FALSE; } assert(count($O6t)>0,"The number of fields in the table is > 0"); $O69->close(); return $O6t; } function O71($l72,$O55,$O1) { l6b($l72,$l3s=FALSE); switch ($O55) { case (l1e): $O72="where lower(".O3.") = '".strtolower($O1)."'"; break; default : $O72="where ".l4." = '$O55' and ".O3." = '".$O1."'"; break; } $l5y=dbcreatedbconnection(KIBELLADB); $l6a=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".l1m." from $l72 $O72"); if ($l6a !== FALSE && count($l6a)>0) { $l73="true"; $O73=$l6a[0][l1m]*1; dbdbhexecutesqlquery($l5y->getdbhandle(),"delete from $l72 $O72" ,$O5="exec"); } else { $l73="false"; $O73=1; } if ($O55 == l1e) { l6b(l3,$l3s=FALSE); dbdbhexecutesqlquery($l5y->getdbhandle(),"delete from ".l3." where ".l1r." = '$O1'" ,$O5="exec"); } $l5y->close(); l74($O55,$O1,$O73,l1k,$l73); } function O6y($l6x,$l6z,&$l6v,&$O6v,$O6w) { $O74=FALSE; if ($O6w !== NULL && count($O6w)>0) { $l75="/_geohash[".l1l."-".O1l."]\$/i"; if (preg_match($l75,$l6x) === 1 && array_search(preg_replace($l75,"",strtolower($l6x)),$O6w) !== FALSE) { $O75=""; $l76=""; $O74=TRUE; } } if (!$O74) { $O76=array_search(strtolower($l6x),$l6v); if ($O76 !== FALSE) { $O75="date"; $l76="date"; unset ($l6v[$O76]); } else { $l77=array_search(strtolower($l6x),$O6v); if ($l77 !== FALSE) { $O75="geo_point"; $l76="geo_point"; unset ($O6v[$l77]); } else { switch (( string) strtoupper($l6z)) { case ("DOUBLE"): case ("FLOAT"): case ("REAL"): $O75="number"; $l76="double"; break; case ("BIGINT"): case ("INT"): $O75="number"; $l76="long"; break; case ("TEXT"): case ("VARCHAR"): $O75="string"; $l76="string"; break; default : O77($l6z); $O75="string"; $l76="string"; break; } } } } return array("FieldTypeIndex" => $O75,"FieldTypeMappings" => $l76); } function dbgeneratefieldmetadatalong($l6x,$l6z) { $l36="\"".$l6x."\":{"."\"full_name\":\"".$l6x."\","."\"mapping\":{\"".$l6x."\":{"."\"type\":\"".$l6z."\","; if ($l6z === "date") { $l36.="\"analyzer\":\"_date/16\","."\"search_analyzer\":\"_date/max\","."\"format\":\"yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_second\","."\"numeric_resolution\":\"seconds\","; } $l36.="\"index\":\"not_analyzed\""."}"."}"."}"; return $l36; } function dbgeneratefieldmetadatashort($l6x,$l6z) { return "{"."\"name\":\"".$l6x."\","."\"type\":\"".$l6z."\","."\"count\":0,"."\"scripted\":false,"."\"indexed\":true,"."\"analyzed\":false,"."\"doc_values\":true"."}"; } function O6z(&$l36,&$O6v,$l78,$O78) { assert($O6v != NULL,"the input geofields array is not null"); foreach ($O6v as $l79) { $l79=strtolower($l79); $O79=FALSE; $l7a=FALSE; $O7a=FALSE; foreach ($l78 as $l63) { $l6x=$l63["name"]; $l7b=strtolower($l6x); if ($l7b === $l79."_lat") $O79=TRUE; if ($l7b === $l79."_lon") $l7a=TRUE; $O7b=$l79."_geohash"; $l7c=substr($l7b,0,strlen($O7b)); $O7c=substr($l7b,strlen($O7b)); if ($l7c === $O7b && l1l<=$O7c && $O7c<=O1l) $O7a=TRUE; if ($O79 && $l7a && $O7a) break; } if ($O79 && $l7a && $O7a) { if ($l36 == "") $l5e=""; else $l5e=","; $l7d=substr($l6x,0,strlen($l79)); $l36.=$l5e.call_user_func($O78,$l7d,"geo_point"); } unset ($O6v[$l79]); } return $l36; } function l32($l31,$O30) { $O7d=strstr($O30,".",TRUE); if (empty($O7d)) { $O7d=$O30; } return strtoupper($O7d)."(".strtolower($l31).")"; } function l7e() { if (PHP_SAPI !== "cli") { $O7e=str_replace([":","."],"_",$_SERVER["REMOTE_ADDR"]); $l7f=$O7e."_"; } else { $l7f=""; } return "_$l7f".floor(microtime(1))."_".rand(0,023420); } function O7f($O1) { $l6y=FALSE; $l70=l7g($O1); $O7g=json_decode($l70,TRUE); if ($O7g != NULL && array_key_exists("docs",$O7g) && count($O7g["docs"])>0) { $l7h=$O7g["docs"][0][l1i]["fields"]; $O7h=json_decode($l7h,TRUE); $l6y=array(); foreach ($O7h as $l7i) { $l6y["\"".$l7i["name"]."\""]=$l7i["type"]; } } return $l6y; } function O60($O31) { l6b(l3,$l3s=FALSE); $l5y=dbcreatedbconnection(KIBELLADB); $l60=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".l1r.", ".O3.", ".O1r." from ".l3." where ".l4." = '".O4."' and ".l1r." = '".$O31."'"); $l5y->close(); if ($l60 == FALSE or count($l60) == 0) { return FALSE; } return $l60; } function O65($O31,$O63=0) { l6b(O1s,$l3s=FALSE); $l5y=dbcreatedbconnection(KIBELLADB); $l65=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".l1t.", ".l1u.", ".O1u.", ".l1v." from ".O1s." where ".l1u." = '".$O31."' and ".l1v." >= $O63"." order by ".l1v." desc"); $l5y->close(); if ($l65 == FALSE or count($l65) == 0) { return FALSE; } return $l65; } function l62($O31) { l6b(O1s,$l3s=FALSE); $l5y=dbcreatedbconnection(KIBELLADB); $O7i=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".l1v.", count(*) as n "." from ".O1s." where ".l1u." = '".$O31."'"." group by ".l1v." order by ".l1v." desc"); $l5y->close(); if ($O7i === FALSE or count($O7i) == 0) { return FALSE; } return $O7i; } function l7j($lo,$lp) { if ($lp === l19) { return basename(realpath(DATADIR."/$lo")); } else { return $lo; } } function l5w($O31) { l6b(l1n,$l3s=FALSE); $l5y=dbcreatedbconnection(KIBELLADB); $O7j=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".O1n.", ".l1o.", ".O1o.", ".O1q." from ".l1n." where ".O3." = '$O31'"); $l5y->close(); if ($O7j == FALSE or count($O7j) == 0) { return FALSE; } $l31=$O7j[0][O1n]; $O30=$O7j[0][l1o]; $lp=l4e($O7j[0][O1o]); $l7k=strtolower(CACHEMODE) !== "none" && ($O7j[0][O1q] == 1); $O7k=array("table" => $l31,"db" => $O30,"dbengine" => $lp,"cache" => $l7k); return $O7k; } function l7g($O31) { l6b(l1n,$l3s=FALSE); $l5y=dbcreatedbconnection(KIBELLADB); $l6a=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".O1n.", ".l1o.", ".O1o.", ".l1p.", ".O1p.", ".l1q." from ".l1n." where lower(".O3.") = '".strtolower($O31)."'"); $l5y->close(); if ($l6a !== FALSE && count($l6a)>0) { $l31=$l6a[0][O1n]; $O30=$l6a[0][l1o]; $lp=l4e($l6a[0][O1o]); $O6s=$l6a[0][l1p]; $l6t=$l6a[0][O1p]; $l7l=$l6a[0][l1q]; $l70=l6s($O31,$O30,$l31,$lp,$O6s,$l6t); } else { $l70=FALSE; } return $l70; } function O7l($O1) { l6b(l1n,$l3s=FALSE); $l5y=dbcreatedbconnection(KIBELLADB); $l6a=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".O1n.", ".l1o.", ".O1o.", ".l1p.", ".O1p.", ".l1q." from ".l1n." where lower(".O3.") = '".strtolower($O1)."'"); $l5y->close(); if ($l6a !== FALSE && count($l6a)>0) { $l31=$l6a[0][O1n]; $O30=$l6a[0][l1o]; $lp=l4e($l6a[0][O1o]); $O6s=$l6a[0][l1p]; $l6t=$l6a[0][O1p]; $l7l=$l6a[0][l1q]; $l71=O70($O1,$O30,$l31,$lp,$O6s,$l6t); } else { $l71=FALSE; } return $l71; } function O6a($O69,$l31) { $O5k=O6e($O69,$l31,O1a); $l6a=dbdbhexecutesqlquery($O69->getdbhandle(),$O5k); return $l6a; } function l7m($O7m) { $l7n=json_decode($O7m["kibanaSavedObjectMeta"]["searchSourceJSON"],TRUE); return $l7n["index"]; } function O7n($O55,$O1,$l7o=TRUE) { l6b(l3,$l3s=FALSE); $l5y=dbcreatedbconnection(KIBELLADB); $O7o=dbdbhexecutesqlquery($l5y->getdbhandle(),"select * from ".l3." where ".l4." = '".$O55."' and ".O3." = '".$O1."'"); $l5y->close(); if ($O7o === FALSE) { echo TAG_ERROR_INTERNAL." when reading from Objects table '".l3."'. ".l17.".\n"; } else { if (count($O7o) == 0) { $l7p="{\"".O1f."\":\"".O13."\",\"".l1g."\":\"".$O55."\",\"".O1g."\":\"".$O1."\",\"".l1k."\":false"."}"; if ($l7o) { $l7p="{\"docs\":[".$l7p."]}"; } } else { $l7p="{\"".O1f."\":\"".O13."\",\"".l1g."\":\"".$O7o[0][l4]."\",\"".O1g."\":\"".$O7o[0][O3]."\",\"".l1h."\":".$O7o[0][l1m]*1 .",\"".l1k."\":true,\"".l1i."\":".$O7o[0][O1r]; $O7p=$O7o[0][O1i]; if ($O7p) $l7p.=",\"".O1i."\":".$O7p; $l7p.="}"; if ($l7o) { $l7p="{\"docs\":[".$l7p."]}"; } } l37($l7p); } } function l7q($O31,$O7q,$l7r) { $O7k=l5w($O31); $l31=$O7k["table"]; $O30=$O7k["db"]; $lp=$O7k["dbengine"]; $O5v=$O7k["cache"]; $O7r=l7s($O31,$O7q); $O7s=l7t($O7r,$O5v); if ($O7s === FALSE) { $O7t["xaggs"]=array(); $O7t["yaggs"]=array(); $O7t["filter"]="where ".O1v." = $l7r"; $O7t["onerec"]=$O7t["filter"]; $O7t["discover"]=array("tab" => TRUE,"limit" => 1); global $O4s; l7u($l31,$O30,$O4s[$lp],$O7t,$O7r["responseFileTmp"]); O7u($O7r,$O5v); } l7v($O7r["responseFileFinal"]); } function O7v($O1) { $l70=l7g($O1); if ($l70 !== FALSE) { $O58=$l70; } else { $l31=O1y; $O30=O1x; $O1=l32($l31,$O30); $O58="{\"docs\":[{\"".O1f."\":\"".O13."\",\"".l1g."\":\"index-pattern\",\"".O1g."\":\"".$O1."\",\"".l1h."\":1,\"".l1k."\":true,\"".l1i."\":{\"title\":\"".$O1."\","."\"fields\":\"[{}]\""."}"."}]"."}"; } l37($O58); } function l7w($O1) { $l71=O7l($O1); if ($l71 !== FALSE) { $O58=$l71; } else { $l31=O1y; $O30=O1x; $O1=l32($l31,$O30); $l6x="_dummy"; $l6z="string"; $O58="{\"".$O1."\":{"."\"mappings\":{"."\"row\":{"."\"_ttl\":{"."\"full_name\":\"_ttl\","."\"mapping\":{"."\"_ttl\":{"."\"enabled\":false,"."\"default\":-1"."}"."}"."},\"".$l6x."\":{"."\"full_name\":\"".$l6x."\","."\"mapping\":{\"".$l6x."\":{"."\"type\":\"".$l6z."\","."\"index\":\"not_analyzed\""."}"."}"."}"."}"."}"."}"."}"; } l37($O58); } function l6r($Op,$O5k) { $l6q=FALSE; if ($Op !== FALSE) { $l6q=@$Op->query($O5k); } return $l6q; } function O7w($l6q) { $l5=FALSE; if ($l6q) { if (get_class($l6q) == "PDOStatement") { $l5=$l6q->fetch( \pdo::FETCH_ASSOC); } else if (get_class($l6q) == "SQLite3Result") { $l5=$l6q->fetcharray(SQLITE3_ASSOC); } } return $l5; } function l7x($O31,$O5k,$l66) { $l3t=l6b(O1s,$l3s=FALSE); $l5y=dbcreatedbconnection(KIBELLADB); $l6a=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".l1t.", ".l1v." from ".O1s." where ".l1t." = '".$l66."'"." and ".l1u." = '$O31'"); $O7x=strftime("%Y/%m/%d %H:%M:%S",time()); if (count($l6a) == 0) { $l7y="true"; $O66=1; $l5=dbdbhexecutesqlquery($l5y->getdbhandle(),"insert into ".O1s." values(\t'$l66',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O31',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O5k',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$O66,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O7x'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)" ,$O5="exec"); } else { $O66=$l6a[0][l1v]+1; $l5=dbdbhexecutesqlquery($l5y->getdbhandle(),"update ".O1s." set ".l1t." = '$l66', ".l1u." = '$O31', ".O1u." = '$O5k', ".l1v." = $O66, ".O1t." = '$O7x'"." where ".l1t." = '$l66'" ,$O5="exec"); } $l5y->close(); } function dbregistertable($O7y) { $l7=new user(); if (PHP_SAPI !== "cli" && !$l7->isloggedin()) return FALSE; $l31=$O7y["table"]; $O30=$O7y["db"]; $O4d=$O7y["dbengine"]; $O6s=$O7y["datefields"]; $l6t=$O7y["geofields"]; $l7l=$O7y["linkfields"]; $l7z=$O7y["enablecache"]; if ($O30 == "") { showmessage("","note",O7z("Database")); } if ($l31 == "") { showmessage("","note",O7z("Table")); } if ($O30 == "" || $l31 == "") { return FALSE; } $O4c=l4e($O4d); global $O4s; $O69=dbcreatedbconnection($O30,$Oo=$O4s[$O4c],$l6g=array("dir" => DATADIR)); if ($O69->lu()<0) { $O1=""; $l3t=$O69->lu(); } else { $l3t=O6d($O69,$l31); if ($l3t === FALSE || $l3t<0) { $O1=""; } else { $l3t=FALSE; $O30=l7j($O30,$O4c); $O1=l32($l31,$O30); $l3t=l6b(l1n,$l3s=TRUE); if ($l3t === FALSE) { return array("id" => $O1,"rc" => FALSE); } $l3t=FALSE; $O7x=strftime("%Y/%m/%d %H:%M:%S",time()); $l5y=dbcreatedbconnection(KIBELLADB); $l6a=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".l1m." from ".l1n." where lower(".O3.") = '".strtolower($O1)."'"); if ($l6a === FALSE) { $l3t=FALSE; } else if (count($l6a) == 0) { $O73=1; $l5=dbdbhexecutesqlquery($l5y->getdbhandle(),"insert into ".l1n." (".O3.",".O1n.",".l1o.",".O1o.",".l1m.",".l1p.",".O1p.",".l1q.",".O1q.",".O1m.")"." values(\t'$O1',\n\t\t\t\t\t\t\t\t\t\t'$l31',\n\t\t\t\t\t\t\t\t\t\t'$O30',\n\t\t\t\t\t\t\t\t\t\t'$O4d',\n\t\t\t\t\t\t\t\t\t\t$O73,\n\t\t\t\t\t\t\t\t\t\t'$O6s',\n\t\t\t\t\t\t\t\t\t\t'$l6t',\n\t\t\t\t\t\t\t\t\t\t'$l7l',\n\t\t\t\t\t\t\t\t\t\t'$l7z',\n\t\t\t\t\t\t\t\t\t\t'$O7x'\n\t\t\t\t\t\t\t\t\t)" ,$O5="exec"); if ($l5 !== FALSE) $l3t=RC_NOTE_TABLE_ADDED; } else { $O73=$l6a[0][l1m]+1; $l5=dbdbhexecutesqlquery($l5y->getdbhandle(),"update ".l1n." set ".O1n." = '$l31', ".l1o." = '$O30', ".O1o." = '$O4d', ".l1m." =  $O73, ".l1p." = '$O6s', ".O1p." = '$l6t', ".l1q." = '$l7l', ".O1q." = $l7z, ".O1m." = '$O7x'"." where lower(".O3.") = '".strtolower($O1)."'",$O5="exec"); if ($l5 !== FALSE) $l3t=RC_NOTE_TABLE_UPDATED; } $l5y->close(); } } return array("id" => $O1,"rc" => $l3t); } function l6d($l3s=FALSE) { $l3t=TRUE; $l5y=dbcreatedbconnection(KIBELLADB); if ($l5y === FALSE) { return FALSE; } $l80=array(l1n,l3,O1s); $l3t=TRUE; foreach ($l80 as $l31) { $l3t=$l3t && l6e($l5y->getdbhandle(),$l31,$l3s=$l3s); } $l5y->close(); return $l3t; } function O80($O55,$l81) { $l7=new user(); if (PHP_SAPI !== "cli" && !$l7->isloggedin()) return FALSE; $O81=json_decode($l81,TRUE); switch ($O55) { case (O1e): case (l1f): $O31=l7m($O81); $O5k=l82(l1x); break; case (O4): $O31=l82(O1w); $O5k=""; break; default : $O31=""; $O5k=""; break; } $l3t=l6b(l3,$l3s=FALSE); if (ADDTABLEPREFIX == 1) { $O82= "$O31: "; $l83=strpos($l81,$O82); if ($l83 === strlen("{\"title\":\"")) { $l81=substr_replace($l81,"",$l83,strlen($O82)); } } else { $O82=""; } $O83="\"title\":\"([^\"]+)\""; $l81=preg_replace( "/$O83/" ,"\"title\":\"".$O82."\$1\"",$l81); preg_match( "/$O83/" ,$l81,$l4j); if (count($l4j)>1) { $l84=$l4j[1]; $O84=l85($l84); } else { $O84=""; } $l5y=dbcreatedbconnection(KIBELLADB); $l6a=dbdbhexecutesqlquery($l5y->getdbhandle(),"select ".O3.", ".l1m." from ".l3." where ".l4." = '$O55' and ".O3." = '".$O84."'"); $O7x=strftime("%Y/%m/%d %H:%M:%S",time()); if (count($l6a) == 0) { $l7y="true"; $O73=1; $l5=dbdbhexecutesqlquery($l5y->getdbhandle(),"insert into ".l3." values(\t'$O31',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O55',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O84',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$O73,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$l81',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O5k', ".l1w.", "."'$O7x'".")",$O5="exec"); } else { $l7y="false"; $O73=$l6a[0][l1m]+1; $l5=dbdbhexecutesqlquery($l5y->getdbhandle(),"update ".l3." set ".l1r." = '$O31', ".l4." = '$O55', ".O3." = '$O84', ".l1m." = $O73, ".O1r." = '$l81', ".l1s." = '$O5k', ".O1m." = '$O7x'"." where ".O3." = '$O84'" ,$O5="exec"); } $l5y->close(); l74($O55,$O84,$O73,O1j,$l7y); } function O85($l72,$O55,$O5p) { l6b($l72,$l3s=FALSE); switch ($O55) { case (O4): case (O1e): case (l1f): $l86=l4; $O86=O3; $l87=O1r; $O72= "where $l86 = '$O55'"; if (LISTONLYTABLEOBJECTS === 1) { $l31=l82(O1w); if ($l31 !== "") { $O72.=" and ".l1r." = '$l31'"; } } if ($O5p != "*") { $O5p=str_replace(" ","-",$O5p); $O72.= " and lower($O86) GLOB lower('*".$O5p."')"; } $l5y=dbcreatedbconnection(KIBELLADB); $l5i=dbdbhexecutesqlquery($l5y->getdbhandle(),"select $l86, $O86, $l87\n\t\t\t\t\t\t\t\t\t\t\t\tfrom $l72\n\t\t\t\t\t\t\t\t\t\t\t\t$O72\n\t\t\t\t\t\t\t\t\t\t\t\torder by $O86"); $l5y->close(); break; case (l1e): $O86=O3; $l87=l1m; $l5y=dbcreatedbconnection(KIBELLADB); $l5i=dbdbhexecutesqlquery($l5y->getdbhandle(),"select $O86, $l87\n\t\t\t\t\t\t\t\t\t\t\t\tfrom $l72\n\t\t\t\t\t\t\t\t\t\t\t\torder by $O86"); $l5y->close(); break; default : showmessage( __FUNCTION__ ,TAG_ERROR_INTERNAL,"Invalid object type ($O55). ".l17.".\n"); break; } if ($l5i === FALSE) { showmessage( __FUNCTION__ ,TAG_ERROR_INTERNAL,"when reading from table '$l72'. ".l17.".\n"); } else { if ($O55 == O4 || $O55 == O1e || $O55 == l1f) { for ($l3v=0; $l3v<count($l5i); $l3v ++) { $l5i[$l3v][$l87]=json_decode($l5i[$l3v][$l87],TRUE); } } else if ($O55 == l1e) { for ($l3v=0; $l3v<count($l5i); $l3v ++) { $l5i[$l3v][l4]=l1e; $l5i[$l3v][$l87]=$l5i[$l3v][$l87]*1; } } O87($l5i); } }