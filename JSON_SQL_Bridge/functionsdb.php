<?php
/*
JSON_SQL_Bridge 1.0
Copyright 2016 Frank Vanden berghen
All Right reserved.

JSON_SQL_Bridge is not a free software. The JSON_SQL_Bridge software is NOT licensed under the "Apache License".
If you are interested in distributing, reselling, modifying, contibuting or in general creating
any derivative work from JSON_SQL_Bridge, please contact Frank Vanden Berghen at frank@timi.eu.
*/
namespace kibella; use O55\l56\O56\l57\O57; require_once ( __DIR__."/users/user.php"); function l58($l22,$l2t=FALSE) { if ($l2t) { switch ($l22) { case (lr): $O58="registered tables"; break; case (Ov): $O58="saved objects"; break; case (Oy): $O58="run queries"; break; default : break; } } $l29=checkdirexistsorcreate(TABLESDIR,$l2t=$l2t,$O2t="The temporary directory with the application's information '".TABLESDIR."' was not found and is being recreated.\n"); if ($l29 === FALSE) { O29( __FUNCTION__ ,lc,l59().O59()); return FALSE; } $l29=l5a($l22,KIBELLADB,TABLESDIR); if ($l29 === le) { if ($l2t) O29("",Ob,"Internal database storing the application's information was not found and is being recreated.\n"); $l29=O5a($l2t=FALSE); } else if ($l29 === Oe) { if ($l2t) O29("",Ob,"The internal table storing the $O58 was not found and is being recreated.\n"); $l5b=dbdbhcreate(KIBELLADB,$O2r=TABLESDIR,$l4x="sqlite"); $l29=O5b($l5b,$l22,FALSE); $l5b->close(); unset ($l5b); } return $l29; } function l5c($l2e,$l22,$O21,$O2r,$O24="sqlite") { $O27=O5c($l22,$O21,$O2r,$O24=$O24); if ($O27 === FALSE) { return FALSE; } foreach ($O27 as $O51) { if (O2x(strtolower($O51["name"])) === strtolower($l2e)) { return TRUE; } } return FALSE; } function l5a($l22,$O21,$O2r) { if (!file_exists( "$O2r/$O21")) { return le; } $O27=O4w( "select * from sqlite_master where type = 'table' and lower(name) = lower('$l22')" ,$O21,$O2r); if ($O27 === FALSE) { return FALSE; } if (count($O27) == 0) { return Oe; } return TRUE; } function l5d($l5b,$l22) { $O27=dbdbhexecutesqlquery($l5b,"select * from sqlite_master where type = 'table' and name = '$l22'"); if ($O27 === FALSE) { return FALSE; } if (count($O27) == 0) { return Oe; } return TRUE; } function O5d(&$l5b,$l4x="pdo",$l5e=FALSE,$O5e="",$l5f=NULL) { if ($l5f == NULL) { O5f($l5b,$l4x=$l4x); } else { assert(count($l5f)>=2 && array_key_exists("dbh",$l5f) && array_key_exists("attachname",$l5f),"Input array \$dbAttachInfo contains the neccessary keys"); $l5g="DETACH DATABASE ".$l5f["attachname"]; dbdbhexecutesqlquery($l5b,$l5g,$l4x="exec"); O5f($l5f["dbh"],$l4x=$l4x); } if ($l5e === TRUE && $O5e != "" && $O5e != ":memory:") { unlink($O5e); } } function O5f(&$l5b,$l4x="pdo") { switch ($l4x) { case ("pdo"): $l5b=NULL; break; case ("sqlite"): $l5b->close(); break; default : $l5b=NULL; break; } unset ($l5b); } function dbdbhcreate($O21,$O2r="",$l4x="pdo",$O5g=array("dbtype" => "sqlite","attributes" => array( \pdo::ATTR_PERSISTENT => true,\pdo::ATTR_STRINGIFY_FETCHES => false)),$l5h=array("flags" => SQLITE3_OPEN_READWRITE)) { $l5b=FALSE; if ($O2r === "") $O0=$O21; else $O0= "$O2r/$O21"; if (strtolower($l4x) === "sqlite") { assert($l5h !== NULL && count($l5h)>=1 && array_key_exists("flags",$l5h),"Input array \$optionsSQLite contains the minimum required attributes"); $O5h=$l5h["flags"]; try { $l5b=new l0($O0,$O5h=$O5h); } catch ( \exception $l1) { O29( __FUNCTION__ ,Oc,$l1->getmessage()." '$O0'.\n"); } } else { assert($O5g !== NULL && count($O5g)>=1 && array_key_exists("dbtype",$O5g),"Input array \$optionsPDO contains the minimum required attributes"); $O24=$O5g["dbtype"]; if (array_key_exists("attributes",$O5g)) { $l5i=$O5g["attributes"]; } else { $l5i=NULL; } try { $l5b=new \pdo( "$O24:$O0"); if ($l5i != NULL) { foreach ($l5i as $O5i => $O2l) { $l5b->setattribute($O5i,$O2l); } } $l5b->setattribute( \pdo::ATTR_ERRMODE,\pdo::ERRMODE_SILENT); } catch ( \l5j $l1) { O29( __FUNCTION__ ,Oc,$l1->getmessage()." '$O0' of type '$O24'.\n"); } } return $l5b; } function O5j($l5b,$l22) { $l29=l5d($l5b,$l22); if ($l29 === TRUE) { dbdbhexecutesqlquery($l5b,"drop table $l22" ,$l4x="exec"); } return $l29; } function dbdbhexecutesqlquery($l5b,$l5k,$l4x="query",$O2i=NULL) { $O5k=FALSE; if ($l4x == "exec") { try { if ($O2i != NULL) { $l5l=@$l5b->prepare($l5k); foreach ($O2i as $O5l => $O2l) { $l5l->bindvalue($O5l,$O2l); } $O5k=@$l5l->execute(); unset ($l5l); } else { $O5k=@$l5b->exec($l5k); } } catch ( \l5j $l1) { } } else { $l5l=@$l5b->query($l5k); if ($l5l) { if (get_class($l5l) == "PDOStatement") { $O5k=$l5l->fetchall( \pdo::FETCH_ASSOC); } else if (get_class($l5l) == "SQLite3Result") { $O5k=array(); while ($l5m=$l5l->fetcharray(SQLITE3_ASSOC)) { $O5k[]=$l5m; } } } unset ($l5l); } return $O5k; } function O5m($O28,$O21,$l22,$l25,$O25,$O2r,$O24="sqlite") { if (strtolower($O24) != "sqlite") { return Od; } $l29=l5a($l22,$O21,$O2r); if ($l29 === FALSE || $l29<0) { return FALSE; } $l5n=O5c($l22,$O21,$O2r,$O24=$O24); if ($l5n === FALSE) { return FALSE; } if (count($l5n) == 0) { return Oe; } $O5n=""; $l5o=l2u($l25); $O5o=l2u($O25); $l4c=""; $l5p=0; $O5p=$O5o; for ($l2v=0; $l2v<count($l5n); $l2v ++) { $l5q=$l5n[$l2v]["name"]; $O5q=$l5n[$l2v]["type"]; $l5r=O5r($l5q,$O5q,$l5o,$O5o,$O5p,$O24=$O24); $l5s=$l5r["FieldTypeIndex"]; if ($l5s !== "") { if ($l5p>0) $l4c=","; $O5n.=$l4c.dbgeneratefieldmetadatashort($l5q,$l5s); $l5p ++; } } if ($O5o != NULL) { O5s($O5n,$O5o,$l5n,"kibella\\dbGenerateFieldMetadataShort"); } $l5t="{\"docs\":[{\"".lj."\":\"".O7."\",\"".Oj."\":\"index-pattern\",\"".lk."\":\"".$O28."\",\"".Ok."\":1,\"".lo."\":true,\"".lm."\":{\"title\":\"".$O28."\","."\"fields\":".O2x($O5n,TRUE)."}"."}]"."}"; return $l5t; } function O5t($O28,$O21,$l22,$l25,$O25,$O2r,$O24="sqlite") { if (strtolower($O24) != "sqlite") { return Od; } $l29=l5a($l22,$O21,$O2r); if ($l29 === FALSE || $l29<0) { return FALSE; } $l5n=O5c($l22,$O21,$O2r,$O24=$O24); if ($l5n === FALSE) { return FALSE; } if (count($l5n) == 0) { return Oe; } $l5u="{\"".$O28."\":{"."\"mappings\":{"."\"row\":{"."\"_ttl\":{"."\"full_name\":\"_ttl\","."\"mapping\":{"."\"_ttl\":{"."\"enabled\":false,"."\"default\":-1"."}"."}"."}"; $l5o=l2u($l25); $O5o=l2u($O25); $l4c=","; $O5p=$O5o; for ($l2v=0; $l2v<count($l5n); $l2v ++) { $l5q=$l5n[$l2v]["name"]; $O5q=$l5n[$l2v]["type"]; $l5r=O5r($l5q,$O5q,$l5o,$O5o,$O5p,$O24=$O24); $l5s=$l5r["FieldTypeMappings"]; if ($l5s !== "") { $l5u.=$l4c.dbgeneratefieldmetadatalong($l5q,$l5s); } } if ($O5o != NULL) { O5s($l5u,$O5o,$l5n,"kibella\\dbGenerateFieldMetadataLong"); } $l5u.="}"."}"."}"."}"; return $l5u; } function O5u($l5v,$O2e,$O28) { l58($l5v,$l2t=FALSE); switch ($O2e) { case (lh): $O5v="where lower(".lq.") = '".strtolower($O28)."'"; break; default : $O5v="where ".Ow." = '$O2e' and ".lq." = '".$O28."'"; break; } $O27=O4w("select ".Oq." from $l5v $O5v" ,KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); if ($O27 !== FALSE && count($O27)>0) { $l5w="true"; $O5w=$O27[0][Oq]*1; O4w( "delete from $l5v $O5v" ,KIBELLADB,TABLESDIR,$l4x="exec",$O24="sqlite"); } else { $l5w="false"; $O5w=1; } if ($O2e == lh) { l58(Ov,$l2t=FALSE); O4w("delete from ".Ov." where ".lw." = '$O28'" ,KIBELLADB,TABLESDIR,$l4x="exec",$O24="sqlite"); } l5x($O2e,$O28,$O5w,lo,$l5w); } function O5x($l22,$O21,$O2r) { $l29=l5a($l22,$O21,$O2r); if ($l29 === TRUE) { O4w( "drop table $l22" ,$O21,$O2r,$l4x="exec"); } return $l29; } function O4w($l5k,$O21,$O2r,$l4x="query",$O24="sqlite",$O2i=NULL) { $O5k=FALSE; $O0= "$O2r/$O21"; try { $l5y=new \pdo( "$O24:$O0"); if ($l4x == "exec") { try { if ($O2i != NULL) { $O5y=@$l5y->prepare($l5k); foreach ($O2i as $O5l => $O2l) { $O5y->bindvalue($O5l,$O2l); } $O5k=$O5y->execute(); unset ($O5y); } else { $O5k=@$l5y->exec($l5k); } } catch ( \l5j $l1) { } } else { $O5y=@$l5y->query($l5k); if ($O5y) { $O5k=$O5y->fetchall( \pdo::FETCH_ASSOC); } unset ($O5y); } unset ($l5y); } catch ( \l5j $l1) { O29( __FUNCTION__ ,Oc,$l1->getmessage()." ".$O0."\n"); } return $O5k; } function O5r($l5q,$l5s,&$l5o,&$O5o,$O5p,$O24="sqlite") { $l5z=FALSE; if ($O5p !== NULL && count($O5p)>0) { $O5z="/_geohash[".Oo."-".lp."]\$/i"; if (preg_match($O5z,$l5q) === 1 && array_search(preg_replace($O5z,"",strtolower($l5q)),$O5p) !== FALSE) { $l60=""; $O60=""; $l5z=TRUE; } } if (!$l5z) { $l61=array_search(strtolower($l5q),$l5o); if ($l61 !== FALSE) { $l60="date"; $O60="date"; unset ($l5o[$l61]); } else { $O61=array_search(strtolower($l5q),$O5o); if ($O61 !== FALSE) { $l60="geo_point"; $O60="geo_point"; unset ($O5o[$O61]); } else { switch (( string) strtoupper($l5s)) { case ("DOUBLE"): case ("FLOAT"): case ("REAL"): $l60="number"; $O60="double"; break; case ("INT"): $l60="number"; $O60="long"; break; case ("TEXT"): $l60="string"; $O60="string"; break; default : l62($l5s,$O24); $l60="string"; $O60="string"; break; } } } } return array("FieldTypeIndex" => $l60,"FieldTypeMappings" => $O60); } function dbgeneratefieldmetadatalong($l5q,$l5s) { $l2g="\"".$l5q."\":{"."\"full_name\":\"".$l5q."\","."\"mapping\":{\"".$l5q."\":{"."\"type\":\"".$l5s."\","; if ($l5s === "date") { $l2g.="\"analyzer\":\"_date/16\","."\"search_analyzer\":\"_date/max\","."\"format\":\"yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_second\","."\"numeric_resolution\":\"seconds\","; } $l2g.="\"index\":\"not_analyzed\""."}"."}"."}"; return $l2g; } function dbgeneratefieldmetadatashort($l5q,$l5s) { return "{"."\"name\":\"".$l5q."\","."\"type\":\"".$l5s."\","."\"count\":0,"."\"scripted\":false,"."\"indexed\":true,"."\"analyzed\":false,"."\"doc_values\":true"."}"; } function O5s(&$l2g,&$O5o,$O62,$l63) { assert($O5o != NULL,"the input geofields array is not null"); foreach ($O5o as $O63) { $O63=strtolower($O63); $l64=FALSE; $O64=FALSE; $l65=FALSE; foreach ($O62 as $O51) { $l5q=$O51["name"]; $O65=strtolower($l5q); if ($O65 === $O63."_lat") $l64=TRUE; if ($O65 === $O63."_lon") $O64=TRUE; $l66=$O63."_geohash"; $O66=substr($O65,0,strlen($l66)); $l67=substr($O65,strlen($l66)); if ($O66 === $l66 && Oo<=$l67 && $l67<=lp) $l65=TRUE; if ($l64 && $O64 && $l65) break; } if ($l64 && $O64 && $l65) { if ($l2g == "") $l4c=""; else $l4c=","; $O67=substr($l5q,0,strlen($O63)); $l2g.=$l4c.call_user_func($l63,$O67,"geo_point"); } unset ($O5o[$O63]); } return $l2g; } function l23($l22,$O21) { return strtoupper(strstr($O21,".",TRUE))."(".strtolower($l22).")"; } function l68() { if (PHP_SAPI !== "cli") { $O68=str_replace(":","_",$_SERVER["REMOTE_ADDR"]); $l69=$O68."_"; } else { $l69=""; } return "_$l69".floor(microtime(1))."_".rand(0,023420); } function O2d($O28) { $l5r=FALSE; $l5t=O69($O28); $l6a=json_decode($l5t,TRUE); if ($l6a != NULL && array_key_exists("docs",$l6a) && count($l6a["docs"])>0) { $O6a=$l6a["docs"][0][lm]["fields"]; $l6b=json_decode($O6a,TRUE); $l5r=array(); foreach ($l6b as $O6b) { $l5r["\"".$O6b["name"]."\""]=$O6b["type"]; } } return $l5r; } function l4z($O22) { l58(Ov,$l2t=FALSE); $O4y=O4w("select ".lw.", ".lq.", ".lx." from ".Ov." where ".Ow." = '".Og."' and ".lw." = '".$O22."'",KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); if ($O4y == FALSE or count($O4y) == 0) { return FALSE; } return $O4y; } function l54($O22,$l52=0) { l58(Oy,$l2t=FALSE); $O53=O4w("select ".lz.", ".l10.", ".O10.", ".l11." from ".Oy." where ".l10." = '".$O22."' and ".l11." >= $l52"." order by ".l11." desc",KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); if ($O53 == FALSE or count($O53) == 0) { return FALSE; } return $O53; } function O50($O22) { l58(Oy,$l2t=FALSE); $l6c=O4w("select ".l11.", count(*) as n "." from ".Oy." where ".l10." = '".$O22."'"." group by ".l11." order by ".l11." desc",KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); if ($l6c === FALSE or count($l6c) == 0) { return FALSE; } return $l6c; } function l4u($O22) { l58(lr,$l2t=FALSE); $O6c=O4w("select ".Os.", ".ls.", ".lv." from ".lr." where ".lq." = '$O22'" ,KIBELLADB,TABLESDIR); if ($O6c == FALSE or count($O6c) == 0) { return FALSE; } $O21=$O6c[0][Os]; $l22=$O6c[0][ls]; $l6d=strtolower(CACHEMODE) !== "none" && ($O6c[0][lv] == 1); $l27=array("table" => $l22,"db" => $O21,"cache" => $l6d); return $l27; } function O69($O22) { l58(lr,$l2t=FALSE); $O27=O4w("select ".ls.", ".Os.", ".lt.", ".Ot.", ".lu.", ".Ou." from ".lr." where lower(".lq.") = '".strtolower($O22)."'",KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); if ($O27 !== FALSE && count($O27)>0) { $l22=$O27[0][ls]; $O21=$O27[0][Os]; $O24=$O27[0][lt]; $l25=$O27[0][Ot]; $O25=$O27[0][lu]; $l26=$O27[0][Ou]; $l5t=O5m($O22,$O21,$l22,$l25,$O25,DATADIR,$O24=$O24); } else { $l5t=FALSE; } return $l5t; } function O6d($O28) { l58(lr,$l2t=FALSE); $O27=O4w("select ".ls.", ".Os.", ".lt.", ".Ot.", ".lu.", ".Ou." from ".lr." where lower(".lq.") = '".strtolower($O28)."'",KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); if ($O27 !== FALSE && count($O27)>0) { $l22=$O27[0][ls]; $O21=$O27[0][Os]; $O24=$O27[0][lt]; $l25=$O27[0][Ot]; $O25=$O27[0][lu]; $l26=$O27[0][Ou]; $l5u=O5t($O28,$O21,$l22,$l25,$O25,DATADIR,$O24=$O24); } else { $l5u=FALSE; } return $l5u; } function O5c($l22,$O21,$O2r,$O24="sqlite") { if ($O24 == "sqlite") { return O4w( "PRAGMA table_info('$l22')" ,$O21,$O2r,$l4x="query",$O24=$O24); } else { O29( __FUNCTION__ ,Oc,l6e($O24)); } } function O6e($l6f) { $O6f=json_decode($l6f["kibanaSavedObjectMeta"]["searchSourceJSON"],TRUE); return $O6f["index"]; } function l6g($O2e,$O28,$O6g=TRUE) { l58(Ov,$l2t=FALSE); $l6h=O4w("select * from ".Ov." where ".Ow." = '".$O2e."' and ".lq." = '".$O28."'",KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); if ($l6h === FALSE) { echo Oc." when reading from Objects table '".Ov."'. ".ld.".\n"; } else { if (count($l6h) == 0) { $O6h="{\"".lj."\":\"".O7."\",\"".Oj."\":\"".$O2e."\",\"".lk."\":\"".$O28."\",\"".lo."\":false"."}"; if ($O6g) { $O6h="{\"docs\":[".$O6h."]}"; } } else { $O6h="{\"".lj."\":\"".O7."\",\"".Oj."\":\"".$l6h[0][Ow]."\",\"".lk."\":\"".$l6h[0][lq]."\",\"".Ok."\":".$l6h[0][Oq]*1 .",\"".lo."\":true,\"".lm."\":".$l6h[0][lx]; $l6i=$l6h[0][Om]; if ($l6i) $O6h.=",\"".Om."\":".$l6i; $O6h.="}"; if ($O6g) { $O6h="{\"docs\":[".$O6h."]}"; } } O2f($O6h); } } function O6i($O22,$l6j,$O6j) { $l27=l4u($O22); $l22=$l27["table"]; $O21=$l27["db"]; $O4t=$l27["cache"]; $l6k=O6k($O22,$l6j); $l6l=O6l($l6k,$O4t); if ($l6l === FALSE) { $l6m["xaggs"]=array(); $l6m["yaggs"]=array(); $l6m["filter"]= "where rowid = $O6j"; $l6m["discover"]=array("tab" => TRUE,"limit" => l3r(1)); O6m($l22,$O21,$l6m,$l6k["responseFileTmp"]); l6n($l6k,$O4t); } O6n($l6k["responseFileFinal"]); } function l6o($O28) { $l5t=O69($O28); if ($l5t !== FALSE) { $O46=$l5t; } else { $l22=l14; $O21=l13; $O28=l23($l22,$O21); $O46="{\"docs\":[{\"".lj."\":\"".O7."\",\"".Oj."\":\"index-pattern\",\"".lk."\":\"".$O28."\",\"".Ok."\":1,\"".lo."\":true,\"".lm."\":{\"title\":\"".$O28."\","."\"fields\":\"[{}]\""."}"."}]"."}"; } O2f($O46); } function O6o($O28) { $l5u=O6d($O28); if ($l5u !== FALSE) { $O46=$l5u; } else { $l22=l14; $O21=l13; $O28=l23($l22,$O21); $l5q="_dummy"; $l5s="string"; $O46="{\"".$O28."\":{"."\"mappings\":{"."\"row\":{"."\"_ttl\":{"."\"full_name\":\"_ttl\","."\"mapping\":{"."\"_ttl\":{"."\"enabled\":false,"."\"default\":-1"."}"."}"."},\"".$l5q."\":{"."\"full_name\":\"".$l5q."\","."\"mapping\":{\"".$l5q."\":{"."\"type\":\"".$l5s."\","."\"index\":\"not_analyzed\""."}"."}"."}"."}"."}"."}"."}"; } O2f($O46); } function l6p($l5b,$l5k) { $l5l=FALSE; if ($l5b !== FALSE) { $l5l=@$l5b->query($l5k); } return $l5l; } function O6p($l5l,$l6q=0) { $O5k=FALSE; if ($l5l) { if (get_class($l5l) == "PDOStatement") { $O5k=$l5l->fetch( \pdo::FETCH_ASSOC); } else if (get_class($l5l) == "SQLite3Result") { $O5k=$l5l->fetcharray(SQLITE3_ASSOC); } } return $O5k; } function O6q($O22,$O4i,$O54) { $l29=l58(Oy,$l2t=FALSE); $O27=O4w("select ".lz.", ".l11." from ".Oy." where ".lz." = '".$O54."'"." and ".l10." = '$O22'" ,KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); $l2w=strftime("%Y/%m/%d %H:%M:%S",time()); if (count($O27) == 0) { $l6r="true"; $l55=1; $O5k=O4w("insert into ".Oy." values(\t'$O54',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O22',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O4i',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$l55,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$l2w'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)" ,KIBELLADB,TABLESDIR,$l4x="exec",$O24="sqlite"); } else { $l55=$O27[0][l11]+1; $O5k=O4w("update ".Oy." set ".lz." = '$O54', ".l10." = '$O22', ".O10." = '$O4i', ".l11." = $l55, ".Oz." = '$l2w'"." where ".lz." = '$O54'" ,KIBELLADB,TABLESDIR,$l4x="exec",$O24="sqlite"); } } function l28($l27) { $O6r=new user(); if (PHP_SAPI !== "cli" && !$O6r->isloggedin()) return FALSE; $l22=$l27["table"]; $O21=$l27["db"]; $O24=$l27["dbtype"]; $l25=$l27["datefields"]; $O25=$l27["geofields"]; $l26=$l27["linkfields"]; $O26=$l27["enablecache"]; if ($O21 == "") { O29("","note",l6s("Database")); } if ($l22 == "") { O29("","note",l6s("Table")); } if ($O21 == "" || $l22 == "") { return FALSE; } assert($O24 != "","The database type is not empty."); $l29=l5a($l22,$O21,DATADIR); if ($l29 === FALSE || $l29<0) { $O28=""; } else { $l29=FALSE; $O21=basename(realpath(DATADIR."/$O21")); $O28=l23($l22,$O21); $l29=l58(lr,$l2t=TRUE); if ($l29 === FALSE) { return array("id" => $O28,"rc" => FALSE); } $l29=FALSE; $O27=O4w("select ".Oq." from ".lr." where lower(".lq.") = '".strtolower($O28)."'",KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); if ($O27 === FALSE) { $l29=FALSE; } else if (count($O27) == 0) { $O5w=1; $O5k=O4w("insert into ".lr." (".lq.",".ls.",".Os.",".lt.",".Oq.",".Ot.",".lu.",".Ou.",".lv.")"." values(\t'$O28',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$l22',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O21',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O24',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t $O5w,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$l25',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O25',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$l26',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O26'\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)" ,KIBELLADB,TABLESDIR,$l4x="exec",$O24="sqlite"); if ($O5k !== FALSE) $l29=lf; } else { $O5w=$O27[0][Oq]+1; $O5k=O4w("update ".lr." set ".ls." = '$l22', ".Os." = '$O21', ".lt." = '$O24', ".Oq." =  $O5w, ".Ot." = '$l25', ".lu." = '$O25', ".Ou." = '$l26', ".lv." = $O26"." where lower(".lq.") = '".strtolower($O28)."'",KIBELLADB,TABLESDIR,$l4x="exec",$O24="sqlite"); if ($O5k !== FALSE) $l29=Of; } } return array("id" => $O28,"rc" => $l29); } function O5a($l2t=FALSE) { $l29=TRUE; $l5b=dbdbhcreate(KIBELLADB,$O2r=TABLESDIR,$l4x="sqlite"); if ($l5b === FALSE) { return FALSE; } $O6s=array(lr,Ov,Oy); $l29=TRUE; foreach ($O6s as $l22) { $l29=$l29 && O5b($l5b,$l22,$l2t=$l2t); } $l5b->close(); unset ($l5b); return $l29; } function O5b($l5b,$l22,$l2t=FALSE) { assert($l5b !== NULL && $l5b != FALSE,"The database handle is not null nor false"); $l29=O5j($l5b,$l22); if ($l29 === FALSE) { O29( __FUNCTION__ ,Ob,l6t($l22)); } else { switch ($l22) { case (lr): $O6t=lq." TEXT, ".ls." TEXT, ".Os." TEXT, ".lt." TEXT, ".Oq." INT, ".Ot." TEXT, ".lu." TEXT, ".Ou." TEXT, ".lv." NUMBER".",imageFields TEXT".",linkTemplate TEXT".",linkTemplateLabel TEXT".",imageTemplate TEXT".",imageTemplateLabel TEXT".", PRIMARY KEY(".lq.")"; $l6u="Registered tables"; break; case (Ov): $O6t=lw." TEXT, ".Ow." TEXT, ".lq." TEXT, ".Oq." INT, ".lx." TEXT, ".Ox." TEXT, ".ly." INT"; $l6u="Saved objects (visualizations, dashboards, searches)"; break; case (Oy): $O6t=lz." TEXT, ".l10." TEXT, ".O10." TEXT, ".l11." INT, ".Oz." TEXT"; $l6u="Run queries"; break; default : $O6t=""; $l6u=""; break; } $l29=dbdbhexecutesqlquery($l5b,"create table ".$l22." ($O6t)" ,$l4x="exec"); if ($l29 === FALSE) { O29( __FUNCTION__ ,lc,O6u($l22)); } else if ($l2t) { echo l6v($l6u); } } return $l29; } function O6v($O2e,$l6w) { $O6r=new user(); if (PHP_SAPI !== "cli" && !$O6r->isloggedin()) return FALSE; $O6w=json_decode($l6w,TRUE); switch ($O2e) { case (Oh): case (Oi): $O22=O6e($O6w); $O4i=l6x(O12); break; case (Og): $O22=l6x(l12); $O4i=""; break; default : $O22=""; $O4i=""; break; } $l29=l58(Ov,$l2t=FALSE); if (ADDTABLEPREFIX == 1) { $O6x= "$O22: "; $l6y=strpos($l6w,$O6x); if ($l6y === strlen("{\"title\":\"")) { $l6w=substr_replace($l6w,"",$l6y,strlen($O6x)); } } else { $O6x=""; } $O6y="\"title\":\"([^\"]+)\""; $l6w=preg_replace( "/$O6y/" ,"\"title\":\"".$O6x."\$1\"",$l6w); preg_match( "/$O6y/" ,$l6w,$O3e); if (count($O3e)>1) { $l6z=$O3e[1]; $O6z=l70($l6z); } else { $O6z=""; } $O27=O4w("select ".lq.", ".Oq." from ".Ov." where ".Ow." = '$O2e' and ".lq." = '".$O6z."'",KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); if (count($O27) == 0) { $l6r="true"; $O5w=1; $O5k=O4w("insert into ".Ov." values(\t'$O22',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O2e',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O6z',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t$O5w,\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$l6w',\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t'$O4i', ".O11.")",KIBELLADB,TABLESDIR,$l4x="exec",$O24="sqlite"); } else { $l6r="false"; $O5w=$O27[0][Oq]+1; $O5k=O4w("update ".Ov." set ".lw." = '$O22', ".Ow." = '$O2e', ".lq." = '$O6z', ".Oq." = $O5w, ".lx." = '$l6w', ".Ox." = '$O4i'"." where ".lq." = '$O6z'" ,KIBELLADB,TABLESDIR,$l4x="exec",$O24="sqlite"); } l5x($O2e,$O6z,$O5w,On,$l6r); } function O70($l5v,$O2e,$O4n) { l58($l5v,$l2t=FALSE); switch ($O2e) { case (Og): case (Oh): case (Oi): $l71=Ow; $O71=lq; $l72=lx; $O5v= "where $l71 = '$O2e'"; $l22=l6x(l12); if ($l22 !== "") { $O5v.=" and ".lw." = '$l22'"; } if ($O4n != "*") { $O4n=str_replace(" ","-",$O4n); $O5v.= " and lower($O71) GLOB lower('*".$O4n."')"; } $l4g=O4w( "select $l71, $O71, $l72\n\t\t\t\t\t\t\t\t\t\t\tfrom $l5v\n\t\t\t\t\t\t\t\t\t\t\t$O5v\n\t\t\t\t\t\t\t\t\t\t\torder by $O71" ,KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); break; case (lh): $O71=lq; $l72=Oq; $l4g=O4w( "select $O71, $l72\n\t\t\t\t\t\t\t\t\t\t\tfrom $l5v\n\t\t\t\t\t\t\t\t\t\t\torder by $O71" ,KIBELLADB,TABLESDIR,$l4x="query",$O24="sqlite"); break; default : O29( __FUNCTION__ ,Oc,"Invalid object type ($O2e). ".ld.".\n"); break; } if ($l4g === FALSE) { O29( __FUNCTION__ ,Oc,"when reading from table '$l5v'. ".ld.".\n"); } else { if ($O2e == Og || $O2e == Oh || $O2e == Oi) { for ($l2v=0; $l2v<count($l4g); $l2v ++) { $l4g[$l2v][$l72]=json_decode($l4g[$l2v][$l72],TRUE); } } else if ($O2e == lh) { for ($l2v=0; $l2v<count($l4g); $l2v ++) { $l4g[$l2v][Ow]=lh; $l4g[$l2v][$l72]=$l4g[$l2v][$l72]*1; } } O72($l4g); } }